---
phase: 01-auth-basic-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/middleware.ts
  - src/lib/dal/auth.ts
  - src/providers/theme-provider.tsx
  - src/app/layout.tsx
  - src/app/globals.css
  - middleware.ts
  - components.json
autonomous: true
user_setup:
  - service: supabase
    why: "Backend-as-a-service dla auth i database"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon public key"
    dashboard_config:
      - task: "Utworz nowy projekt Supabase"
        location: "https://supabase.com/dashboard -> New project"
      - task: "Wlacz Email auth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"

must_haves:
  truths:
    - "Klient Supabase dziala w przegladarce"
    - "Klient Supabase dziala na serwerze (Server Components)"
    - "Middleware odwieza sesje przy kazdym uzyciu"
    - "Dark mode przelacza sie poprawnie i persystuje po odswiezeniu"
    - "shadcn/ui komponenty sa dostepne do uzycia"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      exports: ["createClient"]
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client"
      exports: ["createClient"]
    - path: "src/lib/dal/auth.ts"
      provides: "Auth verification functions"
      exports: ["getUser", "requireAuth", "verifySession"]
    - path: "middleware.ts"
      provides: "Session refresh middleware"
      contains: "supabase.auth.getUser"
    - path: "src/providers/theme-provider.tsx"
      provides: "Theme provider dla next-themes"
      exports: ["ThemeProvider"]
    - path: "components.json"
      provides: "shadcn/ui configuration"
      contains: "shadcn"
  key_links:
    - from: "src/app/layout.tsx"
      to: "src/providers/theme-provider.tsx"
      via: "ThemeProvider wrapper"
      pattern: "<ThemeProvider"
    - from: "middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "updateSession"
---

<objective>
Konfiguracja Supabase Auth, shadcn/ui i dark mode dla projektu Wirtualny Mentor.

Purpose: Fundament dla auth flows (Plan 02) i protected routes (Plan 03). Bez tego ani login, ani dashboard nie beda dzialac.

Output:
- Klienty Supabase (browser, server, middleware)
- Data Access Layer dla weryfikacji sesji
- shadcn/ui zainicjalizowane z komponentami bazowymi
- Dark mode z next-themes
- Middleware odsiwezajace sesje
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-basic-ui/01-RESEARCH.md

Prior phase context:
@.planning/phases/00-foundation-ai-architecture/00-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase clients i Data Access Layer</name>
  <files>
    - src/lib/supabase/client.ts
    - src/lib/supabase/server.ts
    - src/lib/supabase/middleware.ts
    - src/lib/dal/auth.ts
    - middleware.ts
    - .env.example
  </files>
  <action>
Zainstaluj Supabase:
```bash
npm install @supabase/supabase-js @supabase/ssr
```

Utworz klienty Supabase zgodnie z wzorcami z RESEARCH.md:

1. **src/lib/supabase/client.ts** - Browser client:
   - Eksportuj funkcje `createClient()` uzywajaca `createBrowserClient`
   - Uzyj env vars: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`

2. **src/lib/supabase/server.ts** - Server client:
   - Eksportuj async funkcje `createClient()` uzywajaca `createServerClient`
   - Pobierz cookies z `next/headers`
   - Implementuj `getAll()` i `setAll()` dla cookie management
   - Wrap setAll w try/catch dla Server Components

3. **src/lib/supabase/middleware.ts** - Middleware helper:
   - Eksportuj `updateSession(request)` funkcje
   - Uzyj `createServerClient` z cookie handlers dla request/response
   - Wywolaj `supabase.auth.getUser()` (NIE getSession - nie rewaliduje tokenow!)
   - Zwroc zmodyfikowany response

4. **src/lib/dal/auth.ts** - Data Access Layer:
   - `getUser()` - cached per-request (uzyj React `cache()`), zwraca User | null
   - `requireAuth()` - wywoluje getUser, redirect do /login jesli null
   - `verifySession()` - wywoluje getUser, throw Error jesli null (dla Server Actions)

5. **middleware.ts** (root projektu):
   - Import `updateSession` z lib/supabase/middleware
   - Wywolaj updateSession i zwroc response
   - Matcher: wykluczaj static files i images

6. Zaktualizuj **.env.example**:
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   NEXT_PUBLIC_SITE_URL=http://localhost:3000
   ```

WAZNE:
- NIE blokuj dostepu w middleware (CVE-2025-29927)
- Middleware TYLKO odswieza sesje
- Autoryzacja w DAL (requireAuth, verifySession)
  </action>
  <verify>
```bash
npm run build
```
Build musi przejsc bez bledow TypeScript. Sprawdz czy wszystkie eksporty sa poprawne.
  </verify>
  <done>
- Trzy klienty Supabase utworzone i eksportowane
- DAL z trzema funkcjami auth
- Middleware odswieza sesje
- .env.example zaktualizowany
  </done>
</task>

<task type="auto">
  <name>Task 2: shadcn/ui i dark mode setup</name>
  <files>
    - components.json
    - src/components/ui/button.tsx
    - src/components/ui/card.tsx
    - src/components/ui/input.tsx
    - src/components/ui/label.tsx
    - src/components/ui/form.tsx
    - src/components/layout/theme-toggle.tsx
    - src/providers/theme-provider.tsx
    - src/app/layout.tsx
    - src/app/globals.css
  </files>
  <action>
1. **Inicjalizacja shadcn/ui**:
```bash
npx shadcn@latest init
```
Wybierz:
- Style: New York
- Base color: Neutral
- CSS variables: Yes
- Tailwind CSS: (auto-detect)
- Components path: src/components
- Utils path: src/lib/utils

2. **Zainstaluj komponenty bazowe**:
```bash
npx shadcn@latest add button card input label form avatar
```

3. **Zainstaluj next-themes**:
```bash
npm install next-themes lucide-react
```

4. **src/providers/theme-provider.tsx**:
```typescript
"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}
```

5. **src/components/layout/theme-toggle.tsx**:
   - Przycisk przelaczajacy dark/light mode
   - Uzyj ikony Sun/Moon z lucide-react
   - Uzyj `useTheme` z next-themes

6. **src/app/globals.css** - Dark mode dla Tailwind v4:
   - Dodaj na poczatku: `@custom-variant dark (&:where(.dark, .dark *));`
   - Zachowaj istniejace style
   - Dodaj CSS variables dla :root i .dark (shadcn/ui defaults)

7. **src/app/layout.tsx**:
   - Import ThemeProvider z providers
   - Wrap children w ThemeProvider z:
     - `attribute="class"`
     - `defaultTheme="system"`
     - `enableSystem`
     - `disableTransitionOnChange`
   - Dodaj `suppressHydrationWarning` do html tag
   - Dodaj lang="pl"

8. **Zaktualizuj src/app/page.tsx**:
   - Dodaj ThemeToggle do strony (gorny prawy rog)
   - Import z components/layout/theme-toggle

WAZNE dla Tailwind v4:
- NIE uzywaj tailwind.config.js dla darkMode
- Uzyj @custom-variant w CSS
  </action>
  <verify>
```bash
npm run dev
```
1. Otworz http://localhost:3000
2. Kliknij przycisk theme toggle
3. Theme powinien sie zmienic (tlo strony)
4. Odswiez strone - theme powinien byc zachowany
  </verify>
  <done>
- shadcn/ui zainicjalizowane z komponentami: button, card, input, label, form, avatar
- ThemeProvider dodany do root layout
- ThemeToggle dziala i persystuje wybor
- Dark mode zmienia kolory strony
  </done>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi bez bledow
2. `npm run dev` startuje serwer
3. Theme toggle przelacza dark/light mode
4. Theme persystuje po odswiezeniu
5. Pliki Supabase eksportuja poprawne funkcje (sprawdz importy)
</verification>

<success_criteria>
- Klienty Supabase gotowe do uzycia w auth flows (Plan 02)
- DAL z requireAuth gotowy do ochrony stron (Plan 03)
- shadcn/ui komponenty dostepne dla formularzy auth
- Dark mode dziala i persystuje
- Middleware odswieza sesje automatycznie
</success_criteria>

<output>
Po zakonczeniu utworz `.planning/phases/01-auth-basic-ui/01-01-SUMMARY.md`
</output>
