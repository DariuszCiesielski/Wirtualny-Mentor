---
phase: 01-auth-basic-ui
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(auth)/sign-up/page.tsx
  - src/app/(auth)/sign-up/actions.ts
  - src/app/(auth)/sign-up/check-email/page.tsx
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/forgot-password/actions.ts
  - src/app/(auth)/forgot-password/check-email/page.tsx
  - src/app/(auth)/update-password/page.tsx
  - src/app/(auth)/update-password/actions.ts
  - src/app/(auth)/confirm/route.ts
  - src/app/(auth)/layout.tsx
  - src/app/(auth)/error/page.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Konfiguracja email templates i redirect URLs"
    dashboard_config:
      - task: "Dodaj Site URL: http://localhost:3000"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL"
      - task: "Dodaj Redirect URL: http://localhost:3000/confirm"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs"
      - task: "Opcjonalnie: Wylacz Confirm email dla szybszego testowania"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> Confirm email: OFF"

must_haves:
  truths:
    - "Uzytkownik moze utworzyc konto z emailem i haslem"
    - "Uzytkownik moze sie zalogowac i jest przekierowany na dashboard"
    - "Uzytkownik moze zresetowac haslo przez email"
    - "Sesja uzytkownika persystuje po odswiezeniu przegladarki"
    - "Bledy walidacji sa wyswietlane uzytkownikowi"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Strona logowania"
      min_lines: 30
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Server Action dla logowania"
      exports: ["login"]
    - path: "src/app/(auth)/sign-up/page.tsx"
      provides: "Strona rejestracji"
      min_lines: 30
    - path: "src/app/(auth)/sign-up/actions.ts"
      provides: "Server Action dla rejestracji"
      exports: ["signUp"]
    - path: "src/app/(auth)/forgot-password/actions.ts"
      provides: "Server Action dla reset hasla"
      exports: ["resetPassword"]
    - path: "src/app/(auth)/update-password/actions.ts"
      provides: "Server Action dla nowego hasla"
      exports: ["updatePassword"]
    - path: "src/app/(auth)/confirm/route.ts"
      provides: "Email confirmation handler"
      exports: ["GET"]
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/app/(auth)/login/actions.ts"
      via: "form action"
      pattern: "action={login}"
    - from: "src/app/(auth)/sign-up/actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient import"
      pattern: "supabase.auth.signUp"
    - from: "src/app/(auth)/confirm/route.ts"
      to: "src/lib/supabase/server.ts"
      via: "verifyOtp"
      pattern: "supabase.auth.verifyOtp"
---

<objective>
Kompletny system autentykacji: rejestracja, logowanie, reset hasla, potwierdzenie emaila.

Purpose: Uzytkownik moze utworzyc konto i zalogowac sie, co odblokowuje dostep do chronionego dashboardu (Plan 03).

Output:
- Strony auth: login, sign-up, forgot-password, update-password
- Server Actions dla kazdego flow
- Email confirmation route handler
- Walidacja Zod dla wszystkich formularzy
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-basic-ui/01-RESEARCH.md
@.planning/phases/01-auth-basic-ui/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth layout i login/sign-up pages</name>
  <files>
    - src/app/(auth)/layout.tsx
    - src/app/(auth)/login/page.tsx
    - src/app/(auth)/login/actions.ts
    - src/app/(auth)/sign-up/page.tsx
    - src/app/(auth)/sign-up/actions.ts
    - src/app/(auth)/sign-up/check-email/page.tsx
  </files>
  <action>
1. **src/app/(auth)/layout.tsx** - Auth layout (bez sidebar/nav):
   - Prosty layout centrujacy content
   - Tlo z subtle pattern lub gradient
   - ThemeToggle w gornym prawym rogu
   - Logo/nazwa "Wirtualny Mentor" z linkiem do /

2. **src/app/(auth)/login/page.tsx**:
   - Card z formularzem logowania
   - Pola: email, password (uzyj shadcn Input, Label)
   - Przycisk "Zaloguj sie" (shadcn Button)
   - Link do /sign-up ("Nie masz konta? Zarejestruj sie")
   - Link do /forgot-password ("Nie pamietasz hasla?")
   - Wyswietlanie bledow z Server Action (useActionState lub searchParams)
   - Po zalogowaniu redirect do /dashboard

3. **src/app/(auth)/login/actions.ts**:
   - Server Action `login(formData: FormData)`
   - Walidacja Zod: email (z.email), password (z.string.min(1))
   - Wywolaj `supabase.auth.signInWithPassword({ email, password })`
   - Na sukces: `redirect('/dashboard')`
   - Na blad: return `{ error: string }`

4. **src/app/(auth)/sign-up/page.tsx**:
   - Card z formularzem rejestracji
   - Pola: email, password, confirmPassword
   - Walidacja: password === confirmPassword (client-side)
   - Przycisk "Zarejestruj sie"
   - Link do /login ("Masz juz konto? Zaloguj sie")
   - Wyswietlanie bledow

5. **src/app/(auth)/sign-up/actions.ts**:
   - Server Action `signUp(formData: FormData)`
   - Walidacja Zod: email, password (min 8 znakow), confirmPassword
   - Sprawdz password === confirmPassword server-side
   - Wywolaj `supabase.auth.signUp()` z `emailRedirectTo`
   - Na sukces: `redirect('/sign-up/check-email')`
   - Na blad: return `{ error: string }`

6. **src/app/(auth)/sign-up/check-email/page.tsx**:
   - Informacja "Sprawdz swoja skrzynke email"
   - Instrukcja klikniecia w link potwierdzajacy
   - Link powrotny do /login

WAZNE:
- Uzyj NEXT_PUBLIC_SITE_URL dla emailRedirectTo (nie hardcode localhost)
- Wszystkie teksty po polsku
- Uzyj shadcn/ui components: Card, CardHeader, CardContent, CardFooter, Input, Label, Button
  </action>
  <verify>
```bash
npm run build
```
1. Otworz http://localhost:3000/login - strona sie wyswietla
2. Otworz http://localhost:3000/sign-up - strona sie wyswietla
3. Sprawdz czy formularze maja poprawne pola
  </verify>
  <done>
- Auth layout centruje content i ma theme toggle
- Login page z formularzem i linkami
- Sign-up page z walidacja hasla
- Server Actions z walidacja Zod
- Check-email page po rejestracji
  </done>
</task>

<task type="auto">
  <name>Task 2: Password reset i email confirmation</name>
  <files>
    - src/app/(auth)/forgot-password/page.tsx
    - src/app/(auth)/forgot-password/actions.ts
    - src/app/(auth)/forgot-password/check-email/page.tsx
    - src/app/(auth)/update-password/page.tsx
    - src/app/(auth)/update-password/actions.ts
    - src/app/(auth)/confirm/route.ts
    - src/app/(auth)/error/page.tsx
  </files>
  <action>
1. **src/app/(auth)/forgot-password/page.tsx**:
   - Card z formularzem reset hasla
   - Pole: email
   - Przycisk "Wyslij link resetujacy"
   - Link do /login ("Wrociles? Zaloguj sie")

2. **src/app/(auth)/forgot-password/actions.ts**:
   - Server Action `resetPassword(formData: FormData)`
   - Walidacja Zod: email
   - Wywolaj `supabase.auth.resetPasswordForEmail(email, { redirectTo })`
   - redirectTo: `${SITE_URL}/confirm?next=/update-password`
   - Na sukces: `redirect('/forgot-password/check-email')`

3. **src/app/(auth)/forgot-password/check-email/page.tsx**:
   - Informacja "Sprawdz email"
   - Instrukcja klikniecia w link
   - Link do /login

4. **src/app/(auth)/update-password/page.tsx**:
   - Card z formularzem nowego hasla
   - Pola: password, confirmPassword
   - Przycisk "Ustaw nowe haslo"
   - Po sukcesie redirect do /login z message

5. **src/app/(auth)/update-password/actions.ts**:
   - Server Action `updatePassword(formData: FormData)`
   - Walidacja Zod: password (min 8), confirmPassword
   - Wywolaj `supabase.auth.updateUser({ password })`
   - Na sukces: `redirect('/login?message=Haslo zmienione')`
   - Na blad: return `{ error: string }`

6. **src/app/(auth)/confirm/route.ts** - Email confirmation handler:
   ```typescript
   import { createClient } from '@/lib/supabase/server'
   import { NextResponse, type NextRequest } from 'next/server'

   export async function GET(request: NextRequest) {
     const { searchParams } = new URL(request.url)
     const token_hash = searchParams.get('token_hash')
     const type = searchParams.get('type')
     const next = searchParams.get('next') ?? '/dashboard'

     if (token_hash && type) {
       const supabase = await createClient()
       const { error } = await supabase.auth.verifyOtp({
         type: type as 'recovery' | 'email',
         token_hash,
       })
       if (!error) {
         return NextResponse.redirect(new URL(next, request.url))
       }
     }
     return NextResponse.redirect(new URL('/error?message=Blad weryfikacji', request.url))
   }
   ```

7. **src/app/(auth)/error/page.tsx**:
   - Wyswietl blad z searchParams.message
   - Link do /login ("Wrocic do logowania")

WAZNE:
- confirm/route.ts to Route Handler (GET), nie page
- Obsluguje oba typy: 'recovery' (reset hasla) i 'email' (potwierdzenie rejestracji)
- Uzyj NEXT_PUBLIC_SITE_URL dla redirect URLs
  </action>
  <verify>
1. Otworz http://localhost:3000/forgot-password - strona sie wyswietla
2. Otworz http://localhost:3000/update-password - strona sie wyswietla
3. Otworz http://localhost:3000/error?message=Test - wyswietla "Test"
4. `npm run build` przechodzi bez bledow
  </verify>
  <done>
- Forgot password flow kompletny (form -> check-email)
- Update password po kliknieciu w link
- Email confirmation route handler
- Error page dla bledow weryfikacji
- Wszystkie akcje z walidacja Zod
  </done>
</task>

<task type="auto">
  <name>Task 3: Integracja i redirect zalogowanych</name>
  <files>
    - src/app/(auth)/login/page.tsx
    - src/app/(auth)/sign-up/page.tsx
  </files>
  <action>
1. Zaktualizuj **src/app/(auth)/login/page.tsx**:
   - Na poczatku sprawdz czy user jest zalogowany (getUser z DAL)
   - Jesli zalogowany: `redirect('/dashboard')`
   - Obsluz `?message=` searchParam (np. po zmianie hasla)

2. Zaktualizuj **src/app/(auth)/sign-up/page.tsx**:
   - Na poczatku sprawdz czy user jest zalogowany
   - Jesli zalogowany: `redirect('/dashboard')`

3. Dodaj komponent wyswietlania wiadomosci sukcesu:
   - Jesli searchParams.message istnieje, wyswietl zielony alert
   - Np. "Haslo zmienione pomyslnie"

WAZNE:
- Uzyj `getUser()` z src/lib/dal/auth.ts (cached, nie tworzy nowego requesta)
- To sa Server Components - mozesz uzywac async/await
  </action>
  <verify>
1. Zaloguj sie (jesli masz konto testowe)
2. Wejdz na /login - powinno przekierowac na /dashboard
3. Wyloguj sie
4. Wejdz na /login - strona powinna sie wyswietlic
  </verify>
  <done>
- Zalogowani uzytkownicy sa przekierowani z /login i /sign-up na /dashboard
- Wiadomosci sukcesu wyswietlane po zmianie hasla
- Pelna integracja z DAL
  </done>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi bez bledow
2. Wszystkie strony auth sie wyswietlaja:
   - /login
   - /sign-up
   - /sign-up/check-email
   - /forgot-password
   - /forgot-password/check-email
   - /update-password
   - /error
3. Formularze maja walidacje (puste pole = blad)
4. Linki nawigacyjne dzialaja (login <-> sign-up, forgot-password)
</verification>

<success_criteria>
- Rejestracja dziala (formularz -> email)
- Login dziala (formularz -> redirect do /dashboard lub blad)
- Reset hasla dziala (formularz -> email -> nowe haslo)
- Walidacja Zod na wszystkich formularzach
- Zalogowani uzytkownicy przekierowani z /login na /dashboard
</success_criteria>

<output>
Po zakonczeniu utworz `.planning/phases/01-auth-basic-ui/01-02-SUMMARY.md`
</output>
