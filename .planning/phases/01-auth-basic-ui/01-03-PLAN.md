---
phase: 01-auth-basic-ui
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/app/(dashboard)/profile/page.tsx
  - src/app/(dashboard)/profile/actions.ts
  - src/components/layout/header.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/logout-button.tsx
  - src/components/profile/profile-form.tsx
  - src/components/profile/avatar-upload.tsx
autonomous: false
user_setup:
  - service: supabase
    why: "Storage bucket dla avatarow"
    dashboard_config:
      - task: "Utworz bucket 'avatars' z public access"
        location: "Supabase Dashboard -> Storage -> New bucket -> Name: avatars, Public: ON"
      - task: "Dodaj RLS policy dla avatars (authenticated users can upload)"
        location: "Supabase Dashboard -> Storage -> avatars -> Policies"

must_haves:
  truths:
    - "Zalogowany uzytkownik widzi dashboard"
    - "Niezalogowany uzytkownik jest przekierowany na /login"
    - "Uzytkownik moze wylogowac sie przez przycisk"
    - "Uzytkownik moze edytowac swoje imie"
    - "Uzytkownik moze zmienic avatar"
    - "Sidebar pokazuje nawigacje"
    - "Header pokazuje info o uzytkowniku"
  artifacts:
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout z sidebar i header"
      min_lines: 30
    - path: "src/app/(dashboard)/page.tsx"
      provides: "Dashboard home page"
      min_lines: 20
    - path: "src/app/(dashboard)/profile/page.tsx"
      provides: "Profile edit page"
      min_lines: 30
    - path: "src/app/(dashboard)/profile/actions.ts"
      provides: "Server Actions dla profilu"
      exports: ["updateProfile", "uploadAvatar"]
    - path: "src/components/layout/header.tsx"
      provides: "Header z user info i logout"
      min_lines: 20
    - path: "src/components/layout/sidebar.tsx"
      provides: "Sidebar nawigacji"
      min_lines: 20
    - path: "src/components/layout/logout-button.tsx"
      provides: "Przycisk wylogowania"
      exports: ["LogoutButton"]
  key_links:
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/dal/auth.ts"
      via: "requireAuth"
      pattern: "await requireAuth"
    - from: "src/app/(dashboard)/profile/actions.ts"
      to: "src/lib/supabase/server.ts"
      via: "supabase.auth.updateUser"
      pattern: "supabase.auth.updateUser"
    - from: "src/components/layout/logout-button.tsx"
      to: "src/lib/supabase/client.ts"
      via: "supabase.auth.signOut"
      pattern: "supabase.auth.signOut"
---

<objective>
Protected dashboard z sidebar, header i edycja profilu (imie, avatar).

Purpose: Uzytkownik widzi swoj obszar roboczy po zalogowaniu. Moze zarzadzac swoim profilem. To fundament dla przyszlych funkcji (kursy, notatki).

Output:
- Dashboard layout z sidebar i header
- Strona glowna dashboardu
- Edycja profilu (imie, avatar)
- Przycisk wylogowania
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-auth-basic-ui/01-RESEARCH.md
@.planning/phases/01-auth-basic-ui/01-01-SUMMARY.md
@.planning/phases/01-auth-basic-ui/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard layout z sidebar i header</name>
  <files>
    - src/app/(dashboard)/layout.tsx
    - src/app/(dashboard)/page.tsx
    - src/components/layout/header.tsx
    - src/components/layout/sidebar.tsx
    - src/components/layout/logout-button.tsx
  </files>
  <action>
1. **src/components/layout/sidebar.tsx**:
   - Client component ("use client")
   - Logo/nazwa "Wirtualny Mentor" na gorze
   - Nawigacja z linkami:
     - Dashboard (Home icon)
     - Moje kursy (BookOpen icon) - disabled/placeholder
     - Notatki (FileText icon) - disabled/placeholder
     - Profil (User icon)
   - Active state dla aktualnej strony (usePathname)
   - Szerokosc: 240px (w-60)
   - Uzyj lucide-react dla ikon

2. **src/components/layout/header.tsx**:
   - Server Component (async)
   - Pobierz user z getUser()
   - Wyswietl: avatar (lub inicjaly), imie/email
   - ThemeToggle po prawej
   - LogoutButton po prawej
   - Wysokosc: 64px (h-16)

3. **src/components/layout/logout-button.tsx**:
   - Client component ("use client")
   - Przycisk "Wyloguj" (variant="ghost")
   - onClick: wywolaj supabase.auth.signOut()
   - Po wylogowaniu: redirect do /login (uzyj router.push)
   - Uzyj createClient z lib/supabase/client

4. **src/app/(dashboard)/layout.tsx**:
   - Server Component (async)
   - Na poczatku: `const user = await requireAuth()` - przekieruje jesli nie zalogowany
   - Layout: sidebar po lewej (fixed), header na gorze (sticky), content w srodku
   - Przekaz user do Header jako prop

5. **src/app/(dashboard)/page.tsx**:
   - Strona powitalna dashboardu
   - "Witaj, [imie lub email]!"
   - Krotkie info o nastepnych krokach (np. "Zacznij od utworzenia pierwszego kursu")
   - Placeholder cards dla funkcji (Moje kursy, Notatki, Mentor)

Inspiracja UI (NotebookLM):
- Three-panel layout: sidebar | main content | (opcjonalnie right panel)
- Clean, minimalistyczny design
- Soft shadows na cards
- Subtle hover states

WAZNE:
- requireAuth() w layout zapewnia ze wszystkie podstrony sa chronione
- Uzyj Tailwind dla layoutu, nie CSS Grid (prostsze)
- Dark mode powinien dzialac (shadcn classes)
  </action>
  <verify>
1. `npm run dev`
2. Otworz http://localhost:3000/dashboard (niezalogowany) -> redirect do /login
3. Zaloguj sie
4. Otworz /dashboard -> widac sidebar, header, content
5. Kliknij Wyloguj -> redirect do /login
  </verify>
  <done>
- Dashboard layout z sidebar (240px) i header (64px)
- Sidebar z nawigacja i active state
- Header z user info, theme toggle, logout
- Strona glowna z powitaniem
- Protection przez requireAuth w layout
  </done>
</task>

<task type="auto">
  <name>Task 2: Edycja profilu (imie i avatar)</name>
  <files>
    - src/app/(dashboard)/profile/page.tsx
    - src/app/(dashboard)/profile/actions.ts
    - src/components/profile/profile-form.tsx
    - src/components/profile/avatar-upload.tsx
  </files>
  <action>
1. **src/app/(dashboard)/profile/page.tsx**:
   - Server Component
   - Pobierz user z getUser()
   - Tytul "Twoj profil"
   - Card z ProfileForm i AvatarUpload

2. **src/app/(dashboard)/profile/actions.ts**:
   - `updateProfile(formData: FormData)`:
     - Walidacja Zod: name (1-100 znakow)
     - Wywolaj verifySession() z DAL
     - `supabase.auth.updateUser({ data: { full_name: name } })`
     - Return { success: true } lub { error: string }

   - `uploadAvatar(formData: FormData)`:
     - Wywolaj verifySession() z DAL
     - Pobierz file z formData
     - Walidacja: file exists, max 2MB, type image/*
     - Generuj unique filename: `${user.id}-${Date.now()}.${ext}`
     - Upload do Supabase Storage bucket 'avatars'
     - Pobierz public URL
     - Update user_metadata: `supabase.auth.updateUser({ data: { avatar_url } })`
     - Return { success: true, url } lub { error: string }

3. **src/components/profile/profile-form.tsx**:
   - Client component ("use client")
   - Form z polem "Imie" (Input)
   - Przycisk "Zapisz zmiany"
   - useActionState dla obslugi Server Action
   - Wyswietl sukces/blad

4. **src/components/profile/avatar-upload.tsx**:
   - Client component ("use client")
   - Wyswietl aktualny avatar (Avatar component z shadcn)
   - Input type="file" accept="image/*"
   - Preview przed uploadem
   - Przycisk "Zmien avatar"
   - Loading state podczas uploadu
   - Wyswietl sukces/blad

WAZNE:
- Avatar przechowywany w user_metadata (nie osobna tabela)
- Generuj unique filename przy kazdym uplaodzie (zapobiega cachingowi)
- Uzyj shadcn Avatar component z fallback na inicjaly
- Server Actions musza byc w osobnym pliku (actions.ts), nie w komponencie
  </action>
  <verify>
1. Otworz http://localhost:3000/profile
2. Zmien imie -> kliknij Zapisz -> powinno sie zapisac
3. Zmien avatar -> wybierz plik -> powinien sie uploadowac
4. Odswiez strone -> zmiany powinny byc widoczne
  </verify>
  <done>
- Strona profilu z edycja imienia
- Avatar upload do Supabase Storage
- Zmiany zapisywane w user_metadata
- Walidacja po stronie serwera
- Feedback uzytkownikowi (sukces/blad)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Kompletny system autentykacji i dashboard:
- Rejestracja z email/haslo
- Logowanie z sesja
- Reset hasla
- Protected dashboard z sidebar i header
- Edycja profilu (imie, avatar)
- Dark mode
  </what-built>
  <how-to-verify>
1. Otworz http://localhost:3000
2. Kliknij "Zaloguj sie" lub przejdz do /sign-up
3. Zarejestruj nowe konto (email, haslo min 8 znakow)
4. Sprawdz email (lub jesli Confirm email OFF, od razu zaloguj sie)
5. Zaloguj sie -> powinienes zobaczyc dashboard
6. Kliknij "Profil" w sidebar
7. Zmien imie i zapisz
8. Zmien avatar (wybierz zdjecie)
9. Sprawdz czy zmiany widoczne w headerze
10. Przetestuj dark mode (toggle w headerze)
11. Odswiez strone -> sesja i dark mode powinny byc zachowane
12. Kliknij "Wyloguj" -> redirect do /login
13. Sprobuj wejsc na /dashboard bez logowania -> redirect do /login

Opcjonalnie (reset hasla):
14. Na /login kliknij "Nie pamietasz hasla?"
15. Wpisz email, wyslij
16. Sprawdz email, kliknij link
17. Ustaw nowe haslo
18. Zaloguj sie nowym haslem
  </how-to-verify>
  <resume-signal>Wpisz "approved" jesli wszystko dziala, lub opisz problemy</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi bez bledow
2. Wszystkie strony dashboardu dzialaja:
   - /dashboard (home)
   - /profile (edycja)
3. Protection dziala (niezalogowany -> /login)
4. Logout dziala
5. Profile update dziala (imie, avatar)
6. Dark mode dziala i persystuje
</verification>

<success_criteria>
- Dashboard dostepny tylko dla zalogowanych
- Sidebar z nawigacja i active states
- Header z user info i logout
- Edycja profilu zapisuje zmiany
- Avatar upload do Supabase Storage
- Caly flow auth dziala end-to-end
</success_criteria>

<output>
Po zakonczeniu utworz `.planning/phases/01-auth-basic-ui/01-03-SUMMARY.md`
</output>
