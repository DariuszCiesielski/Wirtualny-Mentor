---
phase: 02-curriculum-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260130000001_courses_schema.sql
  - src/lib/dal/courses.ts
  - src/lib/dal/progress.ts
  - src/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Uzytkownik moze zapisac spersonalizowany kurs do bazy danych"
    - "Postep uzytkownika jest przechowywany miedzy sesjami"
    - "Uzytkownik widzi tylko swoje kursy (inni nie maja dostepu)"
    - "Kurs zawiera zagniezdzone poziomy, outcomes i rozdzialy"
  artifacts:
    - path: "supabase/migrations/20260130000001_courses_schema.sql"
      provides: "Database schema dla curriculum"
      contains: "CREATE TABLE courses"
    - path: "src/lib/dal/courses.ts"
      provides: "Course CRUD operations"
      exports: ["createCourse", "getCourse", "getUserCourses", "updateCourse"]
    - path: "src/lib/dal/progress.ts"
      provides: "Progress tracking operations"
      exports: ["getProgress", "updateProgress", "markChapterComplete"]
    - path: "src/types/database.ts"
      provides: "TypeScript types dla database entities"
      exports: ["Course", "CourseLevel", "Chapter", "UserProgress"]
  key_links:
    - from: "src/lib/dal/courses.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient import"
      pattern: "createClient"
    - from: "src/lib/dal/progress.ts"
      to: "supabase user_progress table"
      via: "Supabase query"
      pattern: "from.*user_progress"

user_setup:
  - service: supabase
    why: "Database tables for curriculum storage"
    dashboard_config:
      - task: "Run migration in Supabase SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> Run migration file"
---

<objective>
Schemat bazy danych dla kursow, poziomow, rozdzialow i postepu uzytkownika.

Purpose: Fundament persystencji dla calej fazy 2 - bez bazy danych nie mozna zapisywac curriculum ani sledzic postepu.
Output: Migracja SQL + TypeScript DAL dla course operations + progress tracking.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curriculum-generation/02-RESEARCH.md
@src/lib/supabase/server.ts
@src/lib/dal/auth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration dla curriculum schema</name>
  <files>
    supabase/migrations/20260130000001_courses_schema.sql
    src/types/database.ts
  </files>
  <action>
Utworz migracje SQL zgodnie z patternem z RESEARCH.md:

1. Tabela `courses`:
   - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
   - user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
   - title TEXT NOT NULL
   - description TEXT
   - target_audience TEXT
   - total_estimated_hours NUMERIC(5,1)
   - prerequisites TEXT[]
   - source_url TEXT (opcjonalny link zrodlowy)
   - user_goals TEXT[]
   - user_experience TEXT CHECK (user_experience IN ('beginner', 'intermediate', 'advanced'))
   - weekly_hours NUMERIC(4,1)
   - status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'generating', 'active', 'completed', 'archived'))
   - created_at, updated_at TIMESTAMPTZ

2. Tabela `course_levels` (5 per course):
   - id UUID PRIMARY KEY
   - course_id UUID REFERENCES courses
   - name TEXT CHECK (name IN ('Poczatkujacy', 'Srednio zaawansowany', 'Zaawansowany', 'Master', 'Guru'))
   - description TEXT
   - estimated_hours NUMERIC(5,1)
   - order_index INT NOT NULL (1-5)
   - UNIQUE(course_id, order_index)

3. Tabela `level_outcomes`:
   - id UUID PRIMARY KEY
   - level_id UUID REFERENCES course_levels
   - description TEXT NOT NULL
   - order_index INT

4. Tabela `chapters`:
   - id UUID PRIMARY KEY
   - level_id UUID REFERENCES course_levels
   - title TEXT NOT NULL
   - description TEXT
   - estimated_minutes INT
   - topics TEXT[]
   - order_index INT

5. Tabela `user_progress`:
   - id UUID PRIMARY KEY
   - user_id UUID REFERENCES auth.users
   - course_id UUID REFERENCES courses
   - current_level_id UUID REFERENCES course_levels
   - current_chapter_id UUID REFERENCES chapters
   - completed_chapters UUID[] DEFAULT '{}'
   - completed_levels UUID[] DEFAULT '{}'
   - started_at, last_activity_at, completed_at TIMESTAMPTZ
   - UNIQUE(user_id, course_id)

6. Tabela `course_resources`:
   - id UUID PRIMARY KEY
   - course_id UUID REFERENCES courses
   - title TEXT, url TEXT, type TEXT

7. RLS Policies:
   - Users can only SELECT/INSERT/UPDATE their own courses
   - Similar policies dla related tables (poziomy, rozdzialy - przez course_id join)

8. Indexy:
   - idx_courses_user_id
   - idx_course_levels_course_id
   - idx_chapters_level_id
   - idx_user_progress_user_course

W `src/types/database.ts` utworz TypeScript types matching schema (Course, CourseLevel, LevelOutcome, Chapter, UserProgress, CourseResource).
  </action>
  <verify>
Sprawdz ze plik migracji jest poprawnym SQL:
- `grep -c "CREATE TABLE" supabase/migrations/20260130000001_courses_schema.sql` powinno zwrocic 6
- `grep -c "CREATE POLICY" supabase/migrations/20260130000001_courses_schema.sql` powinno zwrocic >= 6
- `npx tsc --noEmit` - brak bledow TypeScript w types/database.ts
  </verify>
  <done>
6 tabel utworzonych: courses, course_levels, level_outcomes, chapters, user_progress, course_resources.
RLS policies dla wszystkich tabel. Indexy dla performance.
TypeScript types exportowane z src/types/database.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: DAL dla course operations i progress tracking</name>
  <files>
    src/lib/dal/courses.ts
    src/lib/dal/progress.ts
  </files>
  <action>
Utworz Data Access Layer dla curriculum:

**src/lib/dal/courses.ts:**

1. `createCourse(userId: string, courseData: CreateCourseInput): Promise<Course>`
   - Insert do courses table
   - Zwraca utworzony kurs

2. `saveCurriculumWithLevels(courseId: string, curriculum: CurriculumData): Promise<void>`
   - Batch insert levels do course_levels
   - Batch insert outcomes do level_outcomes
   - Batch insert chapters do chapters
   - Utworz initial user_progress record (current_level = pierwszy, current_chapter = pierwszy)

3. `getCourse(courseId: string): Promise<CourseWithDetails | null>`
   - Select course z nested levels, outcomes, chapters
   - Uzyj Supabase select z relacjami

4. `getUserCourses(userId: string): Promise<CourseWithProgress[]>`
   - Select courses dla usera z progress info
   - Sortuj po last_activity_at DESC

5. `updateCourseStatus(courseId: string, status: CourseStatus): Promise<void>`
   - Update status kursu (draft -> generating -> active)

**src/lib/dal/progress.ts:**

1. `getProgress(userId: string, courseId: string): Promise<UserProgress | null>`
   - Pobierz postep uzytkownika dla kursu

2. `updateProgress(progressId: string, updates: ProgressUpdate): Promise<void>`
   - Aktualizuj current_level_id, current_chapter_id, last_activity_at

3. `markChapterComplete(progressId: string, chapterId: string): Promise<void>`
   - Dodaj chapterId do completed_chapters array
   - Sprawdz czy wszystkie rozdzialy poziomu ukonczone -> dodaj level do completed_levels

4. `calculateProgressPercentage(progress: UserProgress, course: CourseWithDetails): number`
   - Oblicz % ukonczenia (completed_chapters / total_chapters)

Wszystkie funkcje uzywaja `createClient()` z `@/lib/supabase/server` i sa async.
Wszystkie funkcje maja TypeScript types dla inputs/outputs.
  </action>
  <verify>
- `npx tsc --noEmit` - brak bledow TypeScript
- Sprawdz eksporty: `grep -c "export async function" src/lib/dal/courses.ts` >= 4
- Sprawdz eksporty: `grep -c "export async function" src/lib/dal/progress.ts` >= 3
  </verify>
  <done>
DAL courses.ts: createCourse, saveCurriculumWithLevels, getCourse, getUserCourses, updateCourseStatus
DAL progress.ts: getProgress, updateProgress, markChapterComplete, calculateProgressPercentage
Wszystkie funkcje z TypeScript types i Supabase integration.
  </done>
</task>

</tasks>

<verification>
Po ukonczeniu obu taskow:
1. `npm run build` - brak bledow kompilacji
2. Plik migracji gotowy do uruchomienia w Supabase SQL Editor
3. DAL funkcje gotowe do uzycia w server actions
</verification>

<success_criteria>
- [ ] Migracja SQL zawiera 6 tabel z RLS policies
- [ ] TypeScript types w database.ts pasuja do schematu
- [ ] DAL courses.ts eksportuje funkcje CRUD
- [ ] DAL progress.ts eksportuje funkcje progress tracking
- [ ] `npm run build` przechodzi bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/02-curriculum-generation/02-01-SUMMARY.md`
</output>
