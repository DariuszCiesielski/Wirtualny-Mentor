---
phase: 02-curriculum-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/tavily/client.ts
  - src/lib/ai/curriculum/schemas.ts
  - src/lib/ai/curriculum/prompts.ts
  - src/app/api/search/route.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Tavily client moze wykonac web search i zwrocic wyniki"
    - "Zod schemas waliduja strukture curriculum z 5 poziomami"
    - "System prompts sa gotowe dla clarifying questions i curriculum generation"
  artifacts:
    - path: "src/lib/tavily/client.ts"
      provides: "Tavily API wrapper"
      exports: ["searchWeb", "extractUrls"]
    - path: "src/lib/ai/curriculum/schemas.ts"
      provides: "Zod schemas dla AI output"
      exports: ["curriculumSchema", "clarificationSchema", "userInfoSchema"]
    - path: "src/lib/ai/curriculum/prompts.ts"
      provides: "System prompts dla AI"
      exports: ["CLARIFYING_SYSTEM_PROMPT", "CURRICULUM_SYSTEM_PROMPT"]
    - path: "src/app/api/search/route.ts"
      provides: "Web search API endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/lib/tavily/client.ts"
      to: "Tavily API"
      via: "@tavily/core SDK"
      pattern: "tavily.*search"
    - from: "src/lib/ai/curriculum/schemas.ts"
      to: "src/types/database.ts"
      via: "Matching structure"
      pattern: "levelSchema.*name.*Poczatkujacy"

user_setup:
  - service: tavily
    why: "Web search dla aktualnych informacji w curriculum"
    env_vars:
      - name: TAVILY_API_KEY
        source: "https://tavily.com/dashboard -> API Keys"
    account_setup:
      - task: "Utworz konto na tavily.com"
        url: "https://tavily.com"
---

<objective>
Tavily client dla web search i Zod schemas dla strukturyzowanego AI output.

Purpose: Przygotowanie narzedzi AI - search client dla aktualnych informacji i schemas do walidacji structured output.
Output: Tavily wrapper, curriculum schemas, system prompts dla AI.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curriculum-generation/02-RESEARCH.md
@src/lib/ai/providers.ts
@src/types/ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tavily client i web search endpoint</name>
  <files>
    src/lib/tavily/client.ts
    src/app/api/search/route.ts
    .env.example
  </files>
  <action>
1. Zainstaluj Tavily SDK:
   ```bash
   npm install @tavily/core
   ```

2. Utworz `src/lib/tavily/client.ts`:
   ```typescript
   import { tavily } from '@tavily/core';

   const tvly = tavily({ apiKey: process.env.TAVILY_API_KEY! });

   export interface SearchResult {
     title: string;
     url: string;
     content: string;
     score: number;
   }

   export interface SearchResponse {
     answer?: string;
     results: SearchResult[];
   }

   export async function searchWeb(
     query: string,
     options?: {
       topic?: 'general' | 'news';
       maxResults?: number;
       searchDepth?: 'basic' | 'advanced';
     }
   ): Promise<SearchResponse> {
     const response = await tvly.search(query, {
       search_depth: options?.searchDepth || 'basic',
       topic: options?.topic || 'general',
       max_results: options?.maxResults || 5,
       include_answer: true,
     });

     return {
       answer: response.answer,
       results: response.results.map(r => ({
         title: r.title,
         url: r.url,
         content: r.content,
         score: r.score,
       })),
     };
   }

   export async function extractUrls(urls: string[]): Promise<{ url: string; content: string }[]> {
     const response = await tvly.extract(urls);
     return response.results.map(r => ({
       url: r.url,
       content: r.rawContent?.slice(0, 5000) || '', // Limit content
     }));
   }
   ```

3. Utworz `src/app/api/search/route.ts`:
   ```typescript
   import { NextResponse } from 'next/server';
   import { searchWeb } from '@/lib/tavily/client';
   import { z } from 'zod';

   const searchRequestSchema = z.object({
     query: z.string().min(2),
     topic: z.enum(['general', 'news']).optional(),
     maxResults: z.number().int().min(1).max(10).optional(),
   });

   export async function POST(req: Request) {
     try {
       const body = await req.json();
       const { query, topic, maxResults } = searchRequestSchema.parse(body);

       const results = await searchWeb(query, { topic, maxResults });
       return NextResponse.json(results);
     } catch (error) {
       if (error instanceof z.ZodError) {
         return NextResponse.json({ error: 'Invalid request' }, { status: 400 });
       }
       console.error('Search error:', error);
       return NextResponse.json({ error: 'Search failed' }, { status: 500 });
     }
   }
   ```

4. Dodaj do `.env.example`:
   ```
   # Tavily API (web search)
   TAVILY_API_KEY=your_tavily_api_key
   ```
  </action>
  <verify>
- `npm run build` - brak bledow kompilacji
- `grep "TAVILY_API_KEY" .env.example` - klucz jest w przykladzie
- `grep -c "export async function" src/lib/tavily/client.ts` = 2
  </verify>
  <done>
Tavily client z searchWeb i extractUrls.
API endpoint /api/search z walidacja Zod.
TAVILY_API_KEY w .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Curriculum Zod schemas i system prompts</name>
  <files>
    src/lib/ai/curriculum/schemas.ts
    src/lib/ai/curriculum/prompts.ts
  </files>
  <action>
1. Utworz `src/lib/ai/curriculum/schemas.ts`:
   ```typescript
   import { z } from 'zod';

   // Schema dla zebranych informacji o uzytkowniku
   export const userInfoSchema = z.object({
     topic: z.string().describe('Temat nauki'),
     goals: z.array(z.string()).describe('Cele uzytkownika'),
     experience: z.enum(['beginner', 'intermediate', 'advanced']).describe('Poziom doswiadczenia'),
     weeklyHours: z.number().positive().describe('Godziny nauki tygodniowo'),
     sourceUrl: z.string().url().optional().describe('Opcjonalny link zrodlowy'),
   });
   export type UserInfo = z.infer<typeof userInfoSchema>;

   // Schema dla odpowiedzi AI w fazie clarifying questions
   export const clarificationSchema = z.object({
     question: z.string().describe('Pytanie do uzytkownika'),
     options: z.array(z.string()).optional().describe('Sugerowane odpowiedzi'),
     isComplete: z.boolean().describe('Czy zebrano wystarczajaco informacji'),
     collectedInfo: userInfoSchema.partial().optional().describe('Dotychczas zebrane informacje'),
   });
   export type ClarificationResponse = z.infer<typeof clarificationSchema>;

   // Schema dla learning outcome
   export const learningOutcomeSchema = z.object({
     id: z.string(),
     description: z.string().describe('Co uzytkownik bedzie umial po ukonczeniu'),
   });
   export type LearningOutcome = z.infer<typeof learningOutcomeSchema>;

   // Schema dla rozdzialu
   export const chapterSchema = z.object({
     id: z.string(),
     title: z.string(),
     description: z.string(),
     estimatedMinutes: z.number().int().positive(),
     topics: z.array(z.string()),
   });
   export type Chapter = z.infer<typeof chapterSchema>;

   // Schema dla poziomu (5 poziomow w curriculum)
   export const levelSchema = z.object({
     id: z.string(),
     name: z.enum(['Poczatkujacy', 'Srednio zaawansowany', 'Zaawansowany', 'Master', 'Guru']),
     description: z.string(),
     learningOutcomes: z.array(learningOutcomeSchema).min(3).max(7),
     chapters: z.array(chapterSchema).min(3).max(10),
     estimatedHours: z.number().positive(),
   });
   export type Level = z.infer<typeof levelSchema>;

   // Schema dla resource
   export const resourceSchema = z.object({
     title: z.string(),
     url: z.string().url(),
     type: z.enum(['article', 'video', 'documentation', 'course', 'book']),
   });
   export type Resource = z.infer<typeof resourceSchema>;

   // Schema dla pelnego curriculum
   export const curriculumSchema = z.object({
     title: z.string(),
     description: z.string(),
     targetAudience: z.string(),
     totalEstimatedHours: z.number().positive(),
     levels: z.array(levelSchema).length(5), // Dokladnie 5 poziomow
     prerequisites: z.array(z.string()),
     resources: z.array(resourceSchema).optional(),
   });
   export type Curriculum = z.infer<typeof curriculumSchema>;

   // Schema dla standardow edukacyjnych (oficjalne curricula)
   export const educationalStandardSchema = z.object({
     source: z.string().describe('Zrodlo standardu (np. MEN, uniwersytet, certyfikacja)'),
     competencies: z.array(z.string()).describe('Wymagane kompetencje'),
     alignment: z.string().describe('Jak kurs realizuje te standardy'),
   });
   export type EducationalStandard = z.infer<typeof educationalStandardSchema>;
   ```

2. Utworz `src/lib/ai/curriculum/prompts.ts`:
   ```typescript
   export const CLARIFYING_SYSTEM_PROMPT = `Jestes asystentem pomagajacym stworzyc spersonalizowany kurs nauki.

   Twoje zadanie to zebrac informacje od uzytkownika poprzez pytania doprecyzowujace.
   Potrzebujesz poznac:
   1. Dokladny temat nauki (co chce sie nauczyc)
   2. Cele uzytkownika (co chce osiagnac, do czego wykorzysta wiedze)
   3. Dotychczasowe doswiadczenie (poczatkujacy / srednio zaawansowany / zaawansowany)
   4. Ile godzin tygodniowo moze poswiecic na nauke

   ZASADY:
   - Zadawaj JEDNO pytanie na raz
   - Proponuj sugerowane odpowiedzi (options) gdy to mozliwe
   - Po zebraniu wszystkich informacji ustaw isComplete: true
   - Maksymalnie 5 tur konwersacji - potem ustaw isComplete: true z tym co masz
   - Odpowiadaj ZAWSZE po polsku
   - Badz przyjazny i zachecajacy

   Jesli uzytkownik poda link do zrodla, zapisz go w sourceUrl.`;

   export const CURRICULUM_SYSTEM_PROMPT = `Jestes ekspertem w tworzeniu programow nauczania.

   Tworzysz kompleksowy program z DOKLADNIE 5 poziomami:
   1. Poczatkujacy - absolutne podstawy, pierwsze kroki, terminologia
   2. Srednio zaawansowany - rozszerzenie podstaw, pierwsze praktyczne projekty
   3. Zaawansowany - zaawansowane tematy, realne zastosowania
   4. Master - ekspertyza, optymalizacja, edge cases
   5. Guru - mistrzostwo, nauczanie innych, thought leadership

   DLA KAZDEGO POZIOMU:
   - 3-7 learning outcomes ("Po ukonczeniu tego poziomu bedziesz umial...")
   - 3-10 rozdzialow z opisem i szacowanym czasem
   - Opis co uzytkownik osiagnie

   ZASADY:
   - Dostosuj trudnosc do deklarowanego doswiadczenia uzytkownika
   - Uwzglednij cele uzytkownika w doborze tematow
   - Szacuj czas realistycznie (dostepny czas tygodniowo)
   - Uwzglednij aktualne informacje z web search jesli dostarczone
   - Generuj UNIKALNE id dla kazdego elementu (uzyj UUID lub slug)
   - Odpowiadaj ZAWSZE po polsku
   - Unikaj zargonu bez wyjasnienia

   Jesli masz informacje o oficjalnych programach nauczania (szkoly, uczelnie, certyfikacje),
   dostosuj curriculum do tych standardow i wspomnij o tym.`;

   export const OFFICIAL_CURRICULA_SEARCH_PROMPT = `Wyszukaj oficjalne programy nauczania i standardy dla tematu: {topic}

   Szukaj:
   - Programow nauczania MEN (Ministerstwo Edukacji)
   - Programow studiow uczelnianych
   - Certyfikacji branowych (np. AWS, Google, Microsoft)
   - Standardow PRK (Polska Rama Kwalifikacji)
   - Wymagan rynku pracy

   Zwroc uwage na:
   - Wymagane kompetencje
   - Sekwencje nauki (co przed czym)
   - Czas potrzebny na opanowanie`;
   ```
  </action>
  <verify>
- `npx tsc --noEmit` - brak bledow TypeScript
- `grep -c "export const" src/lib/ai/curriculum/schemas.ts` >= 8
- `grep -c "export const" src/lib/ai/curriculum/prompts.ts` >= 2
- `grep "length(5)" src/lib/ai/curriculum/schemas.ts` - schema wymaga 5 poziomow
  </verify>
  <done>
Zod schemas: userInfoSchema, clarificationSchema, curriculumSchema (z dokladnie 5 poziomami).
System prompts: CLARIFYING_SYSTEM_PROMPT, CURRICULUM_SYSTEM_PROMPT, OFFICIAL_CURRICULA_SEARCH_PROMPT.
Wszystkie types exportowane dla uzycia w komponentach.
  </done>
</task>

</tasks>

<verification>
Po ukonczeniu obu taskow:
1. `npm run build` - brak bledow kompilacji
2. Tavily client gotowy do integracji z AI (Task 3)
3. Schemas gotowe dla Output.object() w AI SDK
</verification>

<success_criteria>
- [ ] @tavily/core zainstalowane w package.json
- [ ] Tavily client eksportuje searchWeb i extractUrls
- [ ] API endpoint /api/search dziala z walidacja Zod
- [ ] curriculumSchema wymaga dokladnie 5 poziomow
- [ ] System prompts sa po polsku
- [ ] `npm run build` przechodzi bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/02-curriculum-generation/02-02-SUMMARY.md`
</output>
