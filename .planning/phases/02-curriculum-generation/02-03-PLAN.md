---
phase: 02-curriculum-generation
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/app/(dashboard)/courses/new/page.tsx
  - src/app/(dashboard)/courses/new/actions.ts
  - src/app/api/curriculum/clarify/route.ts
  - src/components/curriculum/topic-input.tsx
  - src/components/curriculum/clarifying-chat.tsx
autonomous: true

must_haves:
  truths:
    - "Uzytkownik moze wpisac temat nauki lub podac link do zrodla"
    - "AI zadaje pytania doprecyzowujace i zbiera informacje o uzytkowniku"
    - "Po zebraniu informacji flow przechodzi do generowania curriculum"
  artifacts:
    - path: "src/app/(dashboard)/courses/new/page.tsx"
      provides: "New course creation page"
      min_lines: 50
    - path: "src/app/api/curriculum/clarify/route.ts"
      provides: "Streaming clarifying questions endpoint"
      exports: ["POST"]
    - path: "src/components/curriculum/topic-input.tsx"
      provides: "Topic input form component"
      contains: "onSubmit"
    - path: "src/components/curriculum/clarifying-chat.tsx"
      provides: "Chat UI for clarifying questions"
      contains: "useChat"
  key_links:
    - from: "src/components/curriculum/clarifying-chat.tsx"
      to: "/api/curriculum/clarify"
      via: "useChat hook"
      pattern: "useChat.*api.*clarify"
    - from: "src/app/api/curriculum/clarify/route.ts"
      to: "src/lib/ai/curriculum/schemas.ts"
      via: "clarificationSchema import"
      pattern: "clarificationSchema"
---

<objective>
Topic input i clarifying questions flow - pierwszy krok tworzenia kursu.

Purpose: Uzytkownik moze rozpoczac tworzenie kursu od wpisania tematu lub linku. AI zadaje pytania doprecyzowujace aby zebrac informacje potrzebne do generowania curriculum.
Output: Strona /courses/new z topic input i chat interface dla pytan AI.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curriculum-generation/02-RESEARCH.md
@.planning/phases/02-curriculum-generation/02-02-SUMMARY.md
@src/lib/ai/providers.ts
@src/lib/ai/curriculum/schemas.ts
@src/lib/ai/curriculum/prompts.ts
@src/components/ui/button.tsx
@src/components/ui/input.tsx
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Topic input component i new course page</name>
  <files>
    src/components/curriculum/topic-input.tsx
    src/app/(dashboard)/courses/new/page.tsx
    src/app/(dashboard)/courses/new/actions.ts
  </files>
  <action>
1. Utworz `src/components/curriculum/topic-input.tsx`:
   - Client component ('use client')
   - Formularz z dwoma polami:
     a) Textarea dla tematu nauki (placeholder: "Czego chcesz sie nauczyc? np. 'programowanie w Python' lub 'prawo cywilne w Polsce'")
     b) Input dla opcjonalnego URL zrodla (placeholder: "Opcjonalnie: link do materialu, na podstawie ktorego chcesz sie uczyc")
   - Walidacja: temat min 3 znaki, URL opcjonalny ale jesli podany to valid URL
   - onSubmit callback z (topic: string, sourceUrl?: string)
   - Przycisk "Rozpocznij" disabled gdy temat < 3 znaki
   - Uzyj shadcn/ui: Button, Input, Card, Textarea (dodaj jesli brak)

2. Utworz `src/app/(dashboard)/courses/new/page.tsx`:
   - Client component z state machine: 'topic' | 'clarify' | 'generate' | 'preview'
   - Krok 1 (topic): Wyswietl TopicInput
   - Krok 2 (clarify): Wyswietl ClarifyingChat (placeholder na razie)
   - Krok 3 (generate): Placeholder "Generowanie curriculum..."
   - Krok 4 (preview): Placeholder "Podglad curriculum"
   - Stepper component pokazujacy aktualny krok (4 kroki: Temat, Pytania, Generowanie, Podglad)
   - State: topic, sourceUrl, userInfo (zebrane z chatu)

3. Utworz `src/app/(dashboard)/courses/new/actions.ts`:
   - Server action `initiateCourseCreation` - tworzy draft course w bazie
   - Input: userId, topic, sourceUrl
   - Output: courseId
   - Status kursu: 'draft'

4. Jesli brak komponentu Textarea w shadcn, dodaj go:
   ```bash
   npx shadcn@latest add textarea
   ```
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "use client" src/components/curriculum/topic-input.tsx` - jest client component
- `grep "onSubmit" src/components/curriculum/topic-input.tsx` - ma callback
- Strona /courses/new renderuje sie bez bledow
  </verify>
  <done>
TopicInput component z walidacja tematu i opcjonalnego URL.
Strona /courses/new z state machine dla 4 krokow.
Server action initiateCourseCreation tworzacy draft course.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clarifying chat endpoint i component</name>
  <files>
    src/app/api/curriculum/clarify/route.ts
    src/components/curriculum/clarifying-chat.tsx
  </files>
  <action>
1. Utworz `src/app/api/curriculum/clarify/route.ts`:
   ```typescript
   import { streamText, Output } from 'ai';
   import { getModel } from '@/lib/ai/providers';
   import { clarificationSchema } from '@/lib/ai/curriculum/schemas';
   import { CLARIFYING_SYSTEM_PROMPT } from '@/lib/ai/curriculum/prompts';

   export async function POST(req: Request) {
     const { messages } = await req.json();

     const result = streamText({
       model: getModel('curriculum'), // GPT-4.1 dla structured output
       system: CLARIFYING_SYSTEM_PROMPT,
       messages,
       output: Output.object({ schema: clarificationSchema }),
     });

     return result.toUIMessageStreamResponse();
   }
   ```

2. Utworz `src/components/curriculum/clarifying-chat.tsx`:
   - Client component ('use client')
   - Props: topic, sourceUrl?, onComplete(userInfo)
   - Uzyj `useChat` z '@ai-sdk/react':
     ```typescript
     const { messages, input, handleInputChange, handleSubmit, isLoading } = useChat({
       api: '/api/curriculum/clarify',
       initialMessages: [
         {
           id: 'initial',
           role: 'user',
           content: sourceUrl
             ? `Chce sie nauczyc na podstawie tego zrodla: ${sourceUrl}. Temat: ${topic}`
             : `Chce sie nauczyc: ${topic}`,
         },
       ],
       onFinish: (message) => {
         // Sprawdz czy AI zebral wszystkie info
         const lastPart = message.parts?.find(p => p.type === 'object');
         if (lastPart?.object?.isComplete) {
           onComplete(lastPart.object.collectedInfo);
         }
       },
     });
     ```
   - Wyswietl historię wiadomości:
     - User messages: prawy brzeg, bg-primary/10
     - AI messages: lewy brzeg, bg-muted
     - Jesli AI podaje options, wyswietl jako klikalne buttony
   - Input z przyciskiem "Wyslij"
   - Loading state podczas oczekiwania na odpowiedz AI
   - Po 5 turach bez isComplete: wyswietl przycisk "Przejdz dalej" (force complete)

3. Polacz z page.tsx:
   - Po onComplete w clarifying-chat, przejdz do kroku 'generate'
   - Zapisz userInfo w state
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "useChat" src/components/curriculum/clarifying-chat.tsx` - uzywa hooka
- `grep "streamText" src/app/api/curriculum/clarify/route.ts` - uzywa streaming
- `grep "Output.object" src/app/api/curriculum/clarify/route.ts` - structured output
  </verify>
  <done>
API endpoint /api/curriculum/clarify z streaming structured output.
ClarifyingChat component z useChat, message history, options buttons.
Polaczenie z page - po zebraniu info przechodzi do generowania.
  </done>
</task>

</tasks>

<verification>
Po ukonczeniu obu taskow:
1. `npm run build` - brak bledow kompilacji
2. Odwiedz /courses/new i:
   - Wpisz temat, kliknij "Rozpocznij"
   - AI powinno zadac pierwsze pytanie (wymaga OPENAI_API_KEY)
   - Odpowiedz na pytania
   - Po zebraniu info powinno przejsc do kroku "Generowanie"
</verification>

<success_criteria>
- [ ] TopicInput przyjmuje temat i opcjonalny URL
- [ ] Strona /courses/new ma 4-krokowy stepper
- [ ] API /api/curriculum/clarify zwraca streaming structured output
- [ ] ClarifyingChat wyswietla historię wiadomości i options
- [ ] Po isComplete: true przechodzi do nastepnego kroku
- [ ] `npm run build` przechodzi bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/02-curriculum-generation/02-03-SUMMARY.md`
</output>
