---
phase: 02-curriculum-generation
plan: 04
type: execute
wave: 2
depends_on: ["02-02", "02-03"]
files_modified:
  - src/app/api/curriculum/generate/route.ts
  - src/components/curriculum/curriculum-generator.tsx
  - src/components/curriculum/curriculum-preview.tsx
  - src/app/(dashboard)/courses/new/actions.ts
autonomous: true

must_haves:
  truths:
    - "AI generuje curriculum z dokladnie 5 poziomami (Poczatkujacy -> Guru)"
    - "Kazdy poziom ma learning outcomes i rozdzialy"
    - "Uzytkownik widzi streaming progress podczas generowania"
    - "Wygenerowane curriculum mozna zapisac do bazy danych"
    - "AI wyszukuje i uwzglednia oficjalne standardy nauczania (Kryterium #11)"
  artifacts:
    - path: "src/app/api/curriculum/generate/route.ts"
      provides: "Streaming curriculum generation endpoint"
      exports: ["POST"]
    - path: "src/components/curriculum/curriculum-generator.tsx"
      provides: "Generator UI with streaming display"
      contains: "useObject"
    - path: "src/components/curriculum/curriculum-preview.tsx"
      provides: "Curriculum preview before save"
      contains: "levels.map"
  key_links:
    - from: "src/app/api/curriculum/generate/route.ts"
      to: "src/lib/ai/curriculum/schemas.ts"
      via: "curriculumSchema import"
      pattern: "curriculumSchema"
    - from: "src/components/curriculum/curriculum-generator.tsx"
      to: "/api/curriculum/generate"
      via: "useObject hook or fetch"
      pattern: "api.*curriculum.*generate"
    - from: "src/app/(dashboard)/courses/new/actions.ts"
      to: "src/lib/dal/courses.ts"
      via: "saveCurriculumWithLevels"
      pattern: "saveCurriculumWithLevels"
---

<objective>
Curriculum generation - AI generuje program nauczania z 5 poziomami.

Purpose: Core funkcjonalnosc fazy - AI tworzy spersonalizowany program nauczania na podstawie zebranych informacji. Uzytkownik widzi streaming progress i moze zapisac wynik.
Output: Endpoint generowania, streaming UI, preview i zapis do bazy.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curriculum-generation/02-RESEARCH.md
@.planning/phases/02-curriculum-generation/02-02-SUMMARY.md
@.planning/phases/02-curriculum-generation/02-03-SUMMARY.md
@src/lib/ai/providers.ts
@src/lib/ai/curriculum/schemas.ts
@src/lib/ai/curriculum/prompts.ts
@src/lib/tavily/client.ts
@src/lib/dal/courses.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Curriculum generation endpoint z web search</name>
  <files>
    src/app/api/curriculum/generate/route.ts
  </files>
  <action>
Utworz `src/app/api/curriculum/generate/route.ts`:

```typescript
import { streamText, Output } from 'ai';
import { getModel } from '@/lib/ai/providers';
import { curriculumSchema, UserInfo } from '@/lib/ai/curriculum/schemas';
import { CURRICULUM_SYSTEM_PROMPT, OFFICIAL_CURRICULA_SEARCH_PROMPT } from '@/lib/ai/curriculum/prompts';
import { searchWeb } from '@/lib/tavily/client';
import { z } from 'zod';

const requestSchema = z.object({
  userInfo: z.object({
    topic: z.string(),
    goals: z.array(z.string()),
    experience: z.enum(['beginner', 'intermediate', 'advanced']),
    weeklyHours: z.number(),
    sourceUrl: z.string().url().optional(),
  }),
  courseId: z.string().uuid(),
});

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { userInfo, courseId } = requestSchema.parse(body);

    // 1. Web search dla aktualnych informacji (optional - skip if no TAVILY_API_KEY)
    let searchResults = '';
    if (process.env.TAVILY_API_KEY) {
      try {
        // Search for general topic info
        const topicSearch = await searchWeb(userInfo.topic, {
          maxResults: 3,
          searchDepth: 'basic',
        });

        // Search for official curricula/standards
        const standardsSearch = await searchWeb(
          OFFICIAL_CURRICULA_SEARCH_PROMPT.replace('{topic}', userInfo.topic),
          { maxResults: 2, searchDepth: 'basic' }
        );

        searchResults = `
## Aktualne informacje o temacie:
${topicSearch.answer || ''}
${topicSearch.results.map(r => `- ${r.title}: ${r.content.slice(0, 200)}`).join('\n')}

## Oficjalne standardy i programy nauczania:
${standardsSearch.answer || ''}
${standardsSearch.results.map(r => `- ${r.title}: ${r.content.slice(0, 200)}`).join('\n')}
        `;
      } catch (e) {
        console.warn('Web search failed, continuing without:', e);
      }
    }

    // 2. Jesli user podal sourceUrl, sprobuj wyciagnac tresc
    let sourceContent = '';
    if (userInfo.sourceUrl && process.env.TAVILY_API_KEY) {
      try {
        const { extractUrls } = await import('@/lib/tavily/client');
        const extracted = await extractUrls([userInfo.sourceUrl]);
        if (extracted[0]?.content) {
          sourceContent = `\n## Tresc ze zrodla uzytkownika:\n${extracted[0].content.slice(0, 3000)}`;
        }
      } catch (e) {
        console.warn('URL extraction failed:', e);
      }
    }

    // 3. Generate curriculum with streaming
    const result = streamText({
      model: getModel('curriculum'),
      system: CURRICULUM_SYSTEM_PROMPT,
      prompt: `Stworz spersonalizowany program nauczania.

## Informacje o uzytkowniku:
- Temat: ${userInfo.topic}
- Cele: ${userInfo.goals.join(', ')}
- Doswiadczenie: ${userInfo.experience === 'beginner' ? 'Poczatkujacy' : userInfo.experience === 'intermediate' ? 'Srednio zaawansowany' : 'Zaawansowany'}
- Dostepny czas: ${userInfo.weeklyHours} godzin tygodniowo

${searchResults}
${sourceContent}

Wygeneruj curriculum z DOKLADNIE 5 poziomami. Kazdy poziom musi miec unikalne ID (uzyj formatu "level-1", "level-2" itd.), 3-7 learning outcomes i 3-10 rozdzialow.`,
      output: Output.object({
        schema: curriculumSchema,
        name: 'curriculum',
        description: 'Spersonalizowany program nauczania z 5 poziomami',
      }),
      maxTokens: 8192, // Curriculum moze byc duze
    });

    return result.toUIMessageStreamResponse();
  } catch (error) {
    if (error instanceof z.ZodError) {
      return new Response(JSON.stringify({ error: 'Invalid request', details: error.errors }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }
    console.error('Curriculum generation error:', error);
    return new Response(JSON.stringify({ error: 'Generation failed' }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
```

UWAGA:
- Endpoint gracefully handles brak TAVILY_API_KEY
- Uzywa searchWeb dla aktualnych info i official curricula
- extractUrls dla source URL uzytkownika
- maxTokens: 8192 dla duzego curriculum
- Streaming response z Output.object
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "streamText" src/app/api/curriculum/generate/route.ts` - uzywa streaming
- `grep "searchWeb" src/app/api/curriculum/generate/route.ts` - integruje Tavily
- `grep "maxTokens" src/app/api/curriculum/generate/route.ts` - ma limit tokenow
- `grep "OFFICIAL_CURRICULA_SEARCH_PROMPT\|standardy\|standards" src/app/api/curriculum/generate/route.ts` - wyszukuje oficjalne programy
  </verify>
  <done>
Endpoint /api/curriculum/generate z:
- Web search dla aktualnych info (Tavily)
- Search dla oficjalnych standardow nauczania
- URL extraction dla source URL
- Streaming structured output z curriculumSchema
  </done>
</task>

<task type="auto">
  <name>Task 2: Generator UI i preview components</name>
  <files>
    src/components/curriculum/curriculum-generator.tsx
    src/components/curriculum/curriculum-preview.tsx
    src/app/(dashboard)/courses/new/actions.ts
  </files>
  <action>
1. Utworz `src/components/curriculum/curriculum-generator.tsx`:
   - Client component
   - Props: userInfo, courseId, onComplete(curriculum)
   - Uzyj `useObject` z '@ai-sdk/react' lub custom fetch z streaming:
     ```typescript
     'use client';
     import { useState, useEffect } from 'react';
     import { Curriculum } from '@/lib/ai/curriculum/schemas';
     import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
     import { Loader2 } from 'lucide-react';

     export function CurriculumGenerator({ userInfo, courseId, onComplete }) {
       const [curriculum, setCurriculum] = useState<Partial<Curriculum>>();
       const [isLoading, setIsLoading] = useState(true);
       const [error, setError] = useState<string>();

       useEffect(() => {
         const generate = async () => {
           try {
             const response = await fetch('/api/curriculum/generate', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ userInfo, courseId }),
             });

             if (!response.ok) throw new Error('Generation failed');

             // Read streaming response
             const reader = response.body?.getReader();
             const decoder = new TextDecoder();
             let buffer = '';

             while (reader) {
               const { done, value } = await reader.read();
               if (done) break;

               buffer += decoder.decode(value, { stream: true });
               // Parse partial JSON and update UI
               // (simplified - in real app use AI SDK's built-in parsing)
               try {
                 // Look for object data in stream
                 const match = buffer.match(/{"title".*}/);
                 if (match) {
                   const parsed = JSON.parse(match[0]);
                   setCurriculum(parsed);
                 }
               } catch {} // Ignore parse errors during streaming
             }

             // Final parse
             if (curriculum) {
               onComplete(curriculum as Curriculum);
             }
           } catch (e) {
             setError(e instanceof Error ? e.message : 'Blad generowania');
           } finally {
             setIsLoading(false);
           }
         };

         generate();
       }, [userInfo, courseId]);

       // ... render partial curriculum as it streams
     }
     ```
   - Wyswietl postep generowania:
     - Tytul kursu (gdy dostepny)
     - Lista poziomow (pojawiaja sie stopniowo)
     - Dla kazdego poziomu: nazwa, opis, liczba rozdzialow
   - Loading spinner i komunikaty o postepie
   - Error handling z przyciskiem "Sprobuj ponownie"

2. Utworz `src/components/curriculum/curriculum-preview.tsx`:
   - Client component
   - Props: curriculum, onConfirm, onEdit (optional)
   - Wyswietl pelna strukture curriculum:
     - Tytul i opis kursu
     - Szacowany calkowity czas
     - Prerequisites lista
     - Accordion/Collapsible dla kazdego z 5 poziomow:
       - Nazwa poziomu i opis
       - Lista learning outcomes z checkmarks
       - Lista rozdzialow z czasem
       - Szacowany czas poziomu
   - Przycisk "Zapisz i rozpocznij nauke" -> onConfirm
   - Opcjonalny przycisk "Edytuj" (future feature)

3. Zaktualizuj `src/app/(dashboard)/courses/new/actions.ts`:
   - Dodaj `saveCurriculum` server action:
     ```typescript
     export async function saveCurriculum(courseId: string, curriculum: Curriculum) {
       const { user } = await requireAuth();
       await saveCurriculumWithLevels(courseId, curriculum);
       await updateCourseStatus(courseId, 'active');
       redirect(`/courses/${courseId}`);
     }
     ```

4. Polacz wszystko w page.tsx:
   - Krok 'generate': wyswietl CurriculumGenerator
   - Po onComplete: przejdz do 'preview'
   - Krok 'preview': wyswietl CurriculumPreview
   - Po onConfirm: wywolaj saveCurriculum i redirect
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "fetch.*curriculum/generate\|fetch.*api.*curriculum" src/components/curriculum/curriculum-generator.tsx` - fetch do endpoint
- `grep "setCurriculum" src/components/curriculum/curriculum-generator.tsx` - streaming state update
- `grep "levels.map\|levels?.map" src/components/curriculum/curriculum-preview.tsx` - renderuje poziomy
- `grep "saveCurriculumWithLevels" src/app/(dashboard)/courses/new/actions.ts` - zapisuje do DB
  </verify>
  <done>
CurriculumGenerator: streaming fetch z partial UI updates.
CurriculumPreview: accordion z 5 poziomami, learning outcomes, rozdzialami.
Server action saveCurriculum zapisujacy do bazy i redirect.
  </done>
</task>

</tasks>

<verification>
Po ukonczeniu obu taskow:
1. `npm run build` - brak bledow
2. Pelny flow tworzenia kursu:
   - /courses/new -> wpisz temat
   - Odpowiedz na pytania AI
   - Obserwuj streaming generowania curriculum
   - Preview z 5 poziomami
   - Zapisz -> redirect do /courses/[id]
</verification>

<success_criteria>
- [ ] Endpoint /api/curriculum/generate integruje Tavily search
- [ ] Generator wyswietla postep streaming
- [ ] Preview pokazuje wszystkie 5 poziomow z learning outcomes
- [ ] Zapis do bazy dziala (saveCurriculumWithLevels)
- [ ] Redirect do /courses/[id] po zapisaniu
- [ ] `npm run build` przechodzi bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/02-curriculum-generation/02-04-SUMMARY.md`
</output>
