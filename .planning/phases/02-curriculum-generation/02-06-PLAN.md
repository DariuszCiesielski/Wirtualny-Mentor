---
phase: 02-curriculum-generation
plan: 06
type: execute
wave: 4
depends_on: ["02-05"]
files_modified:
  - src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx
  - src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts
  - src/components/curriculum/progress-bar.tsx
  - src/components/curriculum/chapter-navigation.tsx
autonomous: true

must_haves:
  truths:
    - "Postep uzytkownika jest zapisywany po ukonczeniu rozdzialu"
    - "Uzytkownik widzi pasek postepu (ile przeszedl z kursu)"
    - "Nawigacja miedzy rozdzialami dziala (nastepny/poprzedni)"
    - "Postep persystuje miedzy sesjami"
  artifacts:
    - path: "src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx"
      provides: "Chapter view page"
      min_lines: 50
    - path: "src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts"
      provides: "Server actions for progress"
      exports: ["markComplete"]
    - path: "src/components/curriculum/progress-bar.tsx"
      provides: "Course progress bar component"
      contains: "percentage"
    - path: "src/components/curriculum/chapter-navigation.tsx"
      provides: "Next/Previous chapter buttons"
      contains: "Link"
  key_links:
    - from: "src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts"
      to: "src/lib/dal/progress.ts"
      via: "markChapterComplete import"
      pattern: "markChapterComplete"
---

<objective>
Progress tracking i nawigacja miedzy rozdzialami.

Purpose: Uzytkownik moze przegladac rozdzialy, oznaczac je jako ukonczone i nawigowac miedzy nimi. Pasek postepu pokazuje calkowity progress w kursie.
Output: Strona rozdzialu z placeholder na content, progress bar, przycisk "Ukoncz" i nawigacja.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-curriculum-generation/02-01-SUMMARY.md
@.planning/phases/02-curriculum-generation/02-05-SUMMARY.md
@src/lib/dal/courses.ts
@src/lib/dal/progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chapter page i progress actions</name>
  <files>
    src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx
    src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts
  </files>
  <action>
1. Utworz `src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts`:
   ```typescript
   'use server';

   import { requireAuth } from '@/lib/dal/auth';
   import { getProgress, markChapterComplete, updateProgress } from '@/lib/dal/progress';
   import { getCourse } from '@/lib/dal/courses';
   import { revalidatePath } from 'next/cache';
   import { redirect } from 'next/navigation';

   export async function markComplete(
     courseId: string,
     levelId: string,
     chapterId: string
   ) {
     const { user } = await requireAuth();
     const progress = await getProgress(user.id, courseId);
     if (!progress) throw new Error('Progress not found');

     await markChapterComplete(progress.id, chapterId);

     // Get course to find next chapter
     const course = await getCourse(courseId);
     if (!course) throw new Error('Course not found');

     // Find next chapter
     const currentLevelIndex = course.levels.findIndex(l => l.id === levelId);
     const currentLevel = course.levels[currentLevelIndex];
     const currentChapterIndex = currentLevel.chapters.findIndex(c => c.id === chapterId);

     let nextPath: string;

     if (currentChapterIndex < currentLevel.chapters.length - 1) {
       // Next chapter in same level
       const nextChapter = currentLevel.chapters[currentChapterIndex + 1];
       nextPath = `/courses/${courseId}/${levelId}/${nextChapter.id}`;
       await updateProgress(progress.id, {
         currentChapterId: nextChapter.id,
       });
     } else if (currentLevelIndex < course.levels.length - 1) {
       // First chapter of next level
       const nextLevel = course.levels[currentLevelIndex + 1];
       const firstChapter = nextLevel.chapters[0];
       nextPath = `/courses/${courseId}/${nextLevel.id}/${firstChapter.id}`;
       await updateProgress(progress.id, {
         currentLevelId: nextLevel.id,
         currentChapterId: firstChapter.id,
       });
     } else {
       // Course completed!
       nextPath = `/courses/${courseId}`;
       await updateProgress(progress.id, {
         completedAt: new Date(),
       });
     }

     revalidatePath(`/courses/${courseId}`);
     redirect(nextPath);
   }

   export async function navigateToChapter(
     courseId: string,
     levelId: string,
     chapterId: string
   ) {
     const { user } = await requireAuth();
     const progress = await getProgress(user.id, courseId);
     if (!progress) throw new Error('Progress not found');

     await updateProgress(progress.id, {
       currentLevelId: levelId,
       currentChapterId: chapterId,
     });

     revalidatePath(`/courses/${courseId}`);
   }
   ```

2. Utworz `src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx`:
   ```typescript
   import { requireAuth } from '@/lib/dal/auth';
   import { getCourse } from '@/lib/dal/courses';
   import { getProgress, calculateProgressPercentage } from '@/lib/dal/progress';
   import { notFound } from 'next/navigation';
   import { ProgressBar } from '@/components/curriculum/progress-bar';
   import { ChapterNavigation } from '@/components/curriculum/chapter-navigation';
   import { Button } from '@/components/ui/button';
   import { markComplete } from './actions';
   import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
   import { CheckCircle2 } from 'lucide-react';

   interface Props {
     params: Promise<{ courseId: string; levelId: string; chapterId: string }>;
   }

   export default async function ChapterPage({ params }: Props) {
     const { courseId, levelId, chapterId } = await params;
     const { user } = await requireAuth();

     const course = await getCourse(courseId);
     if (!course) return notFound();

     const progress = await getProgress(user.id, courseId);
     if (!progress) return notFound();

     // Find current level and chapter
     const level = course.levels.find(l => l.id === levelId);
     if (!level) return notFound();

     const chapter = level.chapters.find(c => c.id === chapterId);
     if (!chapter) return notFound();

     const percentage = calculateProgressPercentage(progress, course);
     const isCompleted = progress.completedChapters.includes(chapterId);

     // Calculate prev/next
     const levelIndex = course.levels.findIndex(l => l.id === levelId);
     const chapterIndex = level.chapters.findIndex(c => c.id === chapterId);

     let prevChapter = null;
     let nextChapter = null;

     // Previous
     if (chapterIndex > 0) {
       prevChapter = { levelId, chapterId: level.chapters[chapterIndex - 1].id };
     } else if (levelIndex > 0) {
       const prevLevel = course.levels[levelIndex - 1];
       prevChapter = {
         levelId: prevLevel.id,
         chapterId: prevLevel.chapters[prevLevel.chapters.length - 1].id
       };
     }

     // Next
     if (chapterIndex < level.chapters.length - 1) {
       nextChapter = { levelId, chapterId: level.chapters[chapterIndex + 1].id };
     } else if (levelIndex < course.levels.length - 1) {
       const nextLevel = course.levels[levelIndex + 1];
       nextChapter = { levelId: nextLevel.id, chapterId: nextLevel.chapters[0].id };
     }

     return (
       <div className="container max-w-4xl py-8">
         {/* Progress Bar */}
         <ProgressBar
           percentage={percentage}
           completedChapters={progress.completedChapters.length}
           totalChapters={course.levels.reduce((sum, l) => sum + l.chapters.length, 0)}
           currentLevel={level.name}
         />

         {/* Breadcrumb */}
         <div className="text-sm text-muted-foreground mb-4">
           {course.title} / {level.name} / Rozdzial {chapterIndex + 1}
         </div>

         {/* Chapter Content */}
         <Card className="mb-8">
           <CardHeader>
             <CardTitle className="flex items-center gap-2">
               {chapter.title}
               {isCompleted && <CheckCircle2 className="h-5 w-5 text-green-500" />}
             </CardTitle>
             <p className="text-muted-foreground">{chapter.description}</p>
             <div className="flex gap-4 text-sm text-muted-foreground">
               <span>~{chapter.estimatedMinutes} min</span>
               {chapter.topics.length > 0 && (
                 <span>Tematy: {chapter.topics.join(', ')}</span>
               )}
             </div>
           </CardHeader>
           <CardContent>
             {/* Placeholder dla content - Phase 3 */}
             <div className="bg-muted/50 rounded-lg p-8 text-center text-muted-foreground">
               <p>Tresc rozdzialu zostanie wygenerowana w Phase 3 (Learning Materials).</p>
               <p className="text-sm mt-2">
                 Na razie mozesz oznaczyc rozdzial jako ukonczony i przejsc dalej.
               </p>
             </div>
           </CardContent>
         </Card>

         {/* Complete Button */}
         {!isCompleted && (
           <form action={markComplete.bind(null, courseId, levelId, chapterId)}>
             <Button type="submit" size="lg" className="w-full mb-8">
               Ukoncz rozdzial i przejdz dalej
             </Button>
           </form>
         )}

         {/* Navigation */}
         <ChapterNavigation
           courseId={courseId}
           prevChapter={prevChapter}
           nextChapter={nextChapter}
           isCompleted={isCompleted}
         />
       </div>
     );
   }
   ```
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "markChapterComplete" src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts`
- `grep "ProgressBar" src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx`
  </verify>
  <done>
Chapter page z:
- Progress bar
- Breadcrumb nawigacji
- Chapter content placeholder
- Przycisk "Ukoncz rozdzial"
- Server action markComplete aktualizujaca progress i redirect
  </done>
</task>

<task type="auto">
  <name>Task 2: Progress bar i navigation components</name>
  <files>
    src/components/curriculum/progress-bar.tsx
    src/components/curriculum/chapter-navigation.tsx
  </files>
  <action>
1. Utworz `src/components/curriculum/progress-bar.tsx`:
   ```typescript
   'use client';

   interface ProgressBarProps {
     percentage: number;
     completedChapters: number;
     totalChapters: number;
     currentLevel: string;
   }

   export function ProgressBar({
     percentage,
     completedChapters,
     totalChapters,
     currentLevel,
   }: ProgressBarProps) {
     return (
       <div className="mb-8 p-4 bg-muted/50 rounded-lg">
         <div className="flex justify-between items-center mb-2">
           <span className="text-sm font-medium">Postep kursu</span>
           <span className="text-sm text-muted-foreground">
             {completedChapters} z {totalChapters} rozdzialow
           </span>
         </div>

         <div className="h-2 bg-muted rounded-full overflow-hidden mb-2">
           <div
             className="h-full bg-primary transition-all duration-500 ease-out"
             style={{ width: `${percentage}%` }}
           />
         </div>

         <div className="flex justify-between text-xs text-muted-foreground">
           <span>Aktualny poziom: {currentLevel}</span>
           <span className="font-medium text-foreground">{percentage}%</span>
         </div>
       </div>
     );
   }
   ```

2. Utworz `src/components/curriculum/chapter-navigation.tsx`:
   ```typescript
   'use client';

   import Link from 'next/link';
   import { Button } from '@/components/ui/button';
   import { ChevronLeft, ChevronRight, BookOpen } from 'lucide-react';

   interface ChapterNavigationProps {
     courseId: string;
     prevChapter: { levelId: string; chapterId: string } | null;
     nextChapter: { levelId: string; chapterId: string } | null;
     isCompleted: boolean;
   }

   export function ChapterNavigation({
     courseId,
     prevChapter,
     nextChapter,
     isCompleted,
   }: ChapterNavigationProps) {
     return (
       <div className="flex items-center justify-between border-t pt-6">
         {prevChapter ? (
           <Button variant="outline" asChild>
             <Link href={`/courses/${courseId}/${prevChapter.levelId}/${prevChapter.chapterId}`}>
               <ChevronLeft className="h-4 w-4 mr-2" />
               Poprzedni rozdzial
             </Link>
           </Button>
         ) : (
           <div /> // Spacer
         )}

         <Button variant="outline" asChild>
           <Link href={`/courses/${courseId}`}>
             <BookOpen className="h-4 w-4 mr-2" />
             Spis tresci
           </Link>
         </Button>

         {nextChapter ? (
           <Button
             variant={isCompleted ? "default" : "outline"}
             asChild
           >
             <Link href={`/courses/${courseId}/${nextChapter.levelId}/${nextChapter.chapterId}`}>
               Nastepny rozdzial
               <ChevronRight className="h-4 w-4 ml-2" />
             </Link>
           </Button>
         ) : (
           <Button variant="default" asChild>
             <Link href={`/courses/${courseId}`}>
               Zakoncz kurs
             </Link>
           </Button>
         )}
       </div>
     );
   }
   ```

3. Dodaj do sidebar "Moje kursy" link (odblokuj):
   W `src/components/layout/sidebar.tsx` zmien disabled "Moje kursy" na aktywny link do /courses
  </action>
  <verify>
- `npm run build` - brak bledow
- `grep "percentage" src/components/curriculum/progress-bar.tsx` - wyswietla procent
- `grep "prevChapter\|nextChapter" src/components/curriculum/chapter-navigation.tsx` - nawigacja
- `grep "/courses" src/components/layout/sidebar.tsx` - link w sidebar
  </verify>
  <done>
ProgressBar z:
- Pasek wizualny z animacja
- Licznik rozdzialow
- Aktualny poziom

ChapterNavigation z:
- Poprzedni/Nastepny rozdzial
- Link do spisu tresci
- Przycisk "Zakoncz kurs" na ostatnim rozdziale

Sidebar z aktywnym linkiem do /courses
  </done>
</task>

</tasks>

<verification>
Po ukonczeniu obu taskow:
1. `npm run build` - brak bledow
2. Nawiguj do /courses/[courseId]/[levelId]/[chapterId]:
   - Progress bar pokazuje aktualny postep
   - Widoczny tytul i opis rozdzialu
   - Przycisk "Ukoncz rozdzial" zapisuje postep
   - Po kliknieciu redirect do nastepnego rozdzialu
   - Nawigacja prev/next dziala
3. Odswiez strone - postep persystuje (z bazy)
</verification>

<success_criteria>
- [ ] Chapter page wyswietla progress bar z procentem
- [ ] Przycisk "Ukoncz rozdzial" zapisuje do bazy i redirect
- [ ] Nawigacja prev/next poprawnie oblicza kolejne rozdzialy
- [ ] Po ostatnim rozdziale w kursie pokazuje "Zakoncz kurs"
- [ ] Progress persystuje miedzy sesjami (odswiezenie strony)
- [ ] Sidebar ma aktywny link "Moje kursy"
- [ ] `npm run build` przechodzi bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/02-curriculum-generation/02-06-SUMMARY.md`
</output>
