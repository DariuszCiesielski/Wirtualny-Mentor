---
phase: 03-learning-materials
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/materials/prompts.ts
  - src/lib/ai/materials/tools.ts
autonomous: true

must_haves:
  truths:
    - "AI moze wyszukiwac aktualne zrodla przez web search"
    - "Materialy zawieraja cytaty z weryfikowalnych zrodel"
    - "Tresci sa zgodne z najnowsza dokumentacja (nie starsze niz 2 lata)"
    - "Praktyczne przyklady zawieraja interpretacje oczekiwanych wynikow"
  artifacts:
    - path: "src/lib/ai/materials/prompts.ts"
      provides: "System prompts for material generation"
      exports: ["MATERIAL_GENERATION_PROMPT", "RESEARCH_SYSTEM_PROMPT", "TRANSLATION_PROMPT"]
    - path: "src/lib/ai/materials/tools.ts"
      provides: "AI SDK tools for web search"
      exports: ["searchResourcesTool", "extractContentTool", "materialGenerationTools"]
  key_links:
    - from: "src/lib/ai/materials/tools.ts"
      to: "@/lib/tavily/client"
      via: "import searchWeb, extractUrls"
      pattern: "import.*from.*tavily/client"
    - from: "src/lib/ai/materials/tools.ts"
      to: "ai"
      via: "tool() from ai package"
      pattern: "import.*tool.*from.*ai"
---

<objective>
Stworz AI tools i prompts dla generowania materialow edukacyjnych z grounding.

Purpose: Narzedzia AI SDK (tool calling) pozwalaja modelowi na wyszukiwanie aktualnych informacji przez Tavily przed generowaniem tresci. Prompty zapewniaja spojny format outputu w stylu podrecznika z cytatami.

Output: Web search tools, extraction tools, system prompts dla materialow
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-learning-materials/03-RESEARCH.md
@src/lib/tavily/client.ts
@src/lib/ai/providers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prompts dla material generation</name>
  <files>src/lib/ai/materials/prompts.ts</files>
  <action>
Stworz `src/lib/ai/materials/prompts.ts` z trzema promptami:

```typescript
/**
 * AI Prompts for Learning Materials Generation
 *
 * System prompts that guide AI to generate textbook-like educational content
 * with proper citations, practical examples, and Polish language output.
 */

export const RESEARCH_SYSTEM_PROMPT = `Jestes ekspertem zbierajacym informacje do materialow edukacyjnych.

TWOJA ROLA:
Wyszukujesz i zbierasz aktualne, wiarygodne zrodla dla tresci edukacyjnych.
Preferujesz oficjalna dokumentacje nad blogposty i nieoficjalne tutoriale.

ZASADY WYSZUKIWANIA:
- Szukaj oficjalnej dokumentacji i sprawdzonych zrodel
- Preferuj anglojezyczne zapytania dla lepszych wynikow
- Zapisuj DOKLADNE URL-e znalezionych zrodel
- Wyciagaj kluczowe informacje z dokumentacji
- Weryfikuj wersje oprogramowania (szukaj z rokiem: "React 2025")
- Ignoruj zrodla starsze niz 2 lata dla technologii

TYPY ZRODEL DO SZUKANIA:
1. Oficjalna dokumentacja (docs.*, developer.*)
2. Praktyczne tutoriale (step-by-step guides)
3. Narzedzia i ich linki instalacyjne
4. Przyklady kodu/komend z wyjasnieniami`;

export const MATERIAL_GENERATION_PROMPT = `Jestes ekspertem tworzacym wysokiej jakosci materialy edukacyjne w stylu podrecznika.

TWOJA ROLA:
Tworzysz jasne, przystepne tresci ktore pomagaja uczniom zrozumiec nowe koncepty.
Lacisz teorie z praktyka, podajac konkretne przyklady i komendy do wyprobowania.

FORMAT TRESCI:
1. WPROWADZENIE - krotki opis czego dotyczy rozdzial, po co to sie uczyc
2. KLUCZOWE POJECIA - definicje z przykladami
3. SZCZEGOLOWE WYJASNIENIE - glowna tresc z inline citations [1], [2]
4. PRAKTYCZNE PRZYKLADY - komendy, kod, oczekiwane wyniki
5. NARZEDZIA - linki do narzedzi z instrukcja instalacji
6. ZASOBY DODATKOWE - linki do dokumentacji, kursow, artykulow
7. PODSUMOWANIE - 3-5 bullet points kluczowych wnioskow

ZASADY CYTOWAN:
- KAZDY fakt musi byc poparty zrodlem [n]
- Uzywaj TYLKO url-i ze znalezionych zrodel, NIGDY nie wymyslaj url-i
- Format: "React uzywa Virtual DOM dla optymalizacji [1]"
- Zrodla numeruj kolejno od [1]
- Jesli informacja pochodzi z wielu zrodel: [1][2]

ZASADY PRAKTYCZNE:
- Komendy z pelnym wyjasnieniem co robia
- Oczekiwany output z interpretacja ("Powinienes zobaczyc: ..." + "Jesli widzisz X, oznacza to Y")
- Instalacja krok po kroku (1. ... 2. ... 3. ...)
- Narzedzia z PRAWDZIWYMI linkami URL
- Unikaj "lorem ipsum" - tylko prawdziwe przyklady

INTERPRETACJA WYNIKOW (OBOWIAZKOWE):
Dla kazdego praktycznego przykladu z komenda lub kodem:
- Dodaj sekcje "Jak interpretowac wyniki:" lub "Oczekiwany wynik:"
- Wyjasnij co oznacza sukces vs blad
- Podaj typowe komunikaty bledow i ich rozwiazania
- Przyklad: "Jesli widzisz 'npm ERR!', sprawdz czy Node.js jest zainstalowany"

JEZYK:
- Pisz po polsku
- Terminy techniczne: angielski (polskie wyjasnienie), np. "callback (funkcja zwrotna)"
- Kod i komendy bez tlumaczenia
- Przyjazny ton, bezposredni zwrot do ucznia ("zainstaluj", "uruchom", "sprawdz")

FORMATOWANIE MARKDOWN:
- Naglowki: ## dla sekcji, ### dla podsekcji
- Kod inline: \`kod\`
- Bloki kodu: \`\`\`language\\n...\\n\`\`\`
- Listy: - dla nieuporzdkowanych, 1. dla krokow
- Tabele dla porownan
- > dla waznych uwag i ostrzezen

ZAKAZY:
- NIE wymyslaj URL-i - uzyj tylko te ze zrodel
- NIE pomijaj zrodel przy faktach
- NIE pisz ogolnikow bez konkretow
- NIE przekraczaj 3000 slow na sekcje
- NIE uzywaj emotikonow`;

export const TRANSLATION_PROMPT = `Przetlumacz ponizszy tekst z angielskiego na polski.

ZASADY TLUMACZENIA:
1. Terminy techniczne pozostaw po angielsku z polskim wyjasnieniem w nawiasie przy pierwszym uzyciu
   Przyklad: "callback (funkcja zwrotna)"
2. Kod i komendy NIE tlumacz - pozostaw oryginalne
3. URL-e pozostaw bez zmian
4. Zachowaj formatowanie markdown
5. Nazwy narzedzi i bibliotek pozostaw po angielsku
6. Zachowaj ton oryginalnego tekstu
7. Liczby i jednostki bez zmian

PRZYKLAD:
EN: "Use the callback function to handle async operations."
PL: "Uzyj funkcji callback (wywolanie zwrotne) do obslugi operacji asynchronicznych."`;

export const CONTENT_GENERATION_USER_PROMPT = (
  chapterTitle: string,
  chapterDescription: string,
  topics: string[],
  sources: Array<{ title: string; url: string; content: string }>
) => `Stworz tresc edukacyjna dla rozdzialu: "${chapterTitle}"

OPIS ROZDZIALU:
${chapterDescription}

TEMATY DO POKRYCIA:
${topics.map((t, i) => `${i + 1}. ${t}`).join('\n')}

ZEBRANE ZRODLA:
${sources.map((s, i) => `[${i + 1}] ${s.title}
URL: ${s.url}
Tresc: ${s.content.slice(0, 2000)}
---`).join('\n\n')}

WYMAGANIA:
- Tresc w stylu podrecznika, jasna i przystepna
- Inline citations w formacie [1], [2] odwolujace do zrodel
- Praktyczne przyklady z komendami
- Oczekiwane wyniki i jak je interpretowac (OBOWIAZKOWE dla kazdego przykladu)
- Wszystko po polsku (tlumacz anglojezyczne zrodla)
- Zachowaj oryginalne URL-e do zrodel
- Nie dodawaj zrodel ktorych nie ma na liscie`;
```

WAZNE:
- Prompt jasno zakazuje wymyslania URL-i (anti-hallucination)
- Format outputu zgodny z schema sectionContentSchema
- CONTENT_GENERATION_USER_PROMPT jako funkcja dla dynamicznej zawartosci
- Instrukcje o formatowaniu markdown dla consistent rendering
- OBOWIAZKOWE interpretacje wynikow dla praktycznych przykladow (MAT-06)
  </action>
  <verify>
    - `npx tsc --noEmit` - brak bledow TypeScript
    - Eksportuje: MATERIAL_GENERATION_PROMPT, RESEARCH_SYSTEM_PROMPT, TRANSLATION_PROMPT, CONTENT_GENERATION_USER_PROMPT
  </verify>
  <done>Prompty dla AI material generation gotowe</done>
</task>

<task type="auto">
  <name>Task 2: AI SDK tools dla web search</name>
  <files>src/lib/ai/materials/tools.ts</files>
  <action>
Stworz `src/lib/ai/materials/tools.ts` z narzedzami do wyszukiwania:

```typescript
/**
 * AI SDK Tools for Material Generation
 *
 * Tools that allow AI to search for current information and extract content
 * from external sources during material generation.
 */

import { tool } from 'ai';
import { z } from 'zod';
import { searchWeb, extractUrls } from '@/lib/tavily/client';

/**
 * Tool for searching educational resources
 *
 * AI uses this to find documentation, tutorials, and articles
 * before generating content.
 */
export const searchResourcesTool = tool({
  description: `Wyszukaj aktualne zasoby edukacyjne, dokumentacje i tutoriale na dany temat.
Uzyj tego narzedzia aby znalezc:
- Oficjalna dokumentacje
- Tutoriale i kursy
- Artykuly z przykladami
- Narzedzia i ich linki

WAZNE: Preferuj anglojezyczne zapytania dla lepszych wynikow.`,
  parameters: z.object({
    query: z.string().describe('Zapytanie do wyszukiwarki (preferuj angielskie frazy)'),
    type: z.enum(['documentation', 'tutorial', 'tool', 'article']).optional()
      .describe('Typ szukanego zasobu'),
  }),
  execute: async ({ query, type }) => {
    // Enhance query with type hint for better results
    let enhancedQuery = query;
    if (type) {
      const typeHints: Record<string, string> = {
        documentation: 'official docs documentation',
        tutorial: 'tutorial guide how to',
        tool: 'tool download install',
        article: 'article explained',
      };
      enhancedQuery = `${query} ${typeHints[type]}`;
    }

    try {
      const results = await searchWeb(enhancedQuery, {
        searchDepth: 'advanced',
        maxResults: 5,
      });

      return {
        success: true,
        answer: results.answer,
        sources: results.results.map((r, i) => ({
          id: `src-${Date.now()}-${i + 1}`,
          title: r.title,
          url: r.url,
          content: r.content,
          score: r.score,
          type: type || 'article',
        })),
      };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Search failed',
        sources: [],
      };
    }
  },
});

/**
 * Tool for extracting detailed content from a URL
 *
 * AI uses this when it needs more detailed information
 * from a specific documentation page or tutorial.
 */
export const extractContentTool = tool({
  description: `Wyciagnij szczegolowa tresc z podanego URL (np. dokumentacji, tutoriala).
Uzyj gdy potrzebujesz wiecej szczegolow z konkretnej strony znalezionej przez searchResources.`,
  parameters: z.object({
    url: z.string().url().describe('URL do wyciagniecia tresci'),
    intent: z.string().describe('Co chcesz znalezc w tej stronie'),
  }),
  execute: async ({ url, intent }) => {
    try {
      const extracted = await extractUrls([url]);

      if (!extracted[0]?.content) {
        return {
          success: false,
          error: 'Nie udalo sie wyciagnac tresci',
          url,
        };
      }

      return {
        success: true,
        url,
        content: extracted[0].content.slice(0, 8000), // Limit for context
        extractedFor: intent,
      };
    } catch (error) {
      return {
        success: false,
        error: error instanceof Error ? error.message : 'Extraction failed',
        url,
      };
    }
  },
});

/**
 * Combined tools object for material generation
 */
export const materialGenerationTools = {
  searchResources: searchResourcesTool,
  extractContent: extractContentTool,
};

/**
 * Type for collected sources from tool calls
 */
export interface CollectedSource {
  id: string;
  title: string;
  url: string;
  content: string;
  score?: number;
  type?: string;
}
```

WAZNE:
- Uzywa istniejacego Tavily client z @/lib/tavily/client
- tool() z AI SDK v6 dla proper typing
- searchDepth: 'advanced' dla lepszych wynikow
- Limity content (8000 chars) aby nie przekroczyc context window
- Error handling z success flag
- Unique IDs dla zrodel (timestamp + index)
  </action>
  <verify>
    - `npx tsc --noEmit` - brak bledow TypeScript
    - Eksportuje: searchResourcesTool, extractContentTool, materialGenerationTools
  </verify>
  <done>AI tools dla web search i extraction gotowe</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` przechodzi bez bledow
2. Prompty eksportowane z src/lib/ai/materials/prompts.ts
3. Tools eksportowane z src/lib/ai/materials/tools.ts
4. Tools uzywaja Tavily client z @/lib/tavily/client
</verification>

<success_criteria>
- [ ] MATERIAL_GENERATION_PROMPT zawiera instrukcje o cytatach
- [ ] MATERIAL_GENERATION_PROMPT wymaga interpretacji wynikow dla przykladow praktycznych (MAT-06)
- [ ] searchResourcesTool uzywa searchWeb z Tavily
- [ ] extractContentTool uzywa extractUrls z Tavily
- [ ] Brak bledow TypeScript w projekcie
</success_criteria>

<output>
After completion, create `.planning/phases/03-learning-materials/03-02-SUMMARY.md`
</output>
