---
phase: 03-learning-materials
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx
  - src/components/materials/chapter-content.tsx
  - src/components/materials/generating-state.tsx
autonomous: true

must_haves:
  truths:
    - "Uzytkownik widzi tresc rozdzialu gdy otwiera chapter page"
    - "Loading state pokazuje sie podczas generowania"
    - "Wygenerowany content jest renderowany z markdown"
    - "Zrodla sa wyswietlone na koncu strony"
    - "Narzedzia wyswietlaja sie w grid"
  artifacts:
    - path: "src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx"
      provides: "Chapter detail page"
      contains: "ChapterContent"
    - path: "src/components/materials/chapter-content.tsx"
      provides: "Chapter content with lazy generation"
      exports: ["ChapterContent"]
    - path: "src/components/materials/generating-state.tsx"
      provides: "Content generating state UI"
      exports: ["GeneratingState"]
  key_links:
    - from: "src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx"
      to: "src/components/materials/chapter-content.tsx"
      via: "component import"
      pattern: "import.*ChapterContent"
    - from: "src/components/materials/chapter-content.tsx"
      to: "/api/materials/generate"
      via: "fetch call"
      pattern: "fetch.*api/materials/generate"
    - from: "src/components/materials/chapter-content.tsx"
      to: "src/lib/dal/materials.ts"
      via: "getSectionContent import"
      pattern: "import.*getSectionContent"
---

<objective>
Stworz chapter page z lazy generation materialow.

Purpose: Gdy uzytkownik otwiera chapter, strona sprawdza czy content istnieje. Jesli nie - uruchamia generacje i pokazuje loading state. Content jest renderowany przez komponenty z Plan 04.

Output: Chapter page, lazy loading pattern, generating state UI
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-learning-materials/03-RESEARCH.md
@src/lib/dal/materials.ts
@src/lib/dal/courses.ts
@src/components/materials/content-renderer.tsx
@src/components/materials/source-list.tsx
@src/components/materials/tool-card.tsx
@src/components/curriculum/chapter-navigation.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: GeneratingState component</name>
  <files>src/components/materials/generating-state.tsx</files>
  <action>
Stworz `src/components/materials/generating-state.tsx`:

```typescript
'use client';

/**
 * Generating State Component
 *
 * Shows progress while AI generates chapter content.
 * Displays animated skeleton and status messages.
 */

import { Loader2, BookOpen, Search, Sparkles } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';

interface GeneratingStateProps {
  chapterTitle: string;
  phase?: 'searching' | 'generating' | 'saving';
}

const phaseMessages = {
  searching: {
    icon: Search,
    title: 'Szukam zrodel...',
    description: 'Przeszukuje dokumentacje i tutoriale dla najnowszych informacji.',
  },
  generating: {
    icon: Sparkles,
    title: 'Generuje materialy...',
    description: 'Tworze tresc edukacyjna na podstawie znalezionych zrodel.',
  },
  saving: {
    icon: BookOpen,
    title: 'Zapisuje...',
    description: 'Zapisuje wygenerowane materialy.',
  },
};

export function GeneratingState({ chapterTitle, phase = 'searching' }: GeneratingStateProps) {
  const { icon: Icon, title, description } = phaseMessages[phase];

  return (
    <div className="space-y-8">
      {/* Status card */}
      <Card className="border-dashed">
        <CardContent className="pt-6">
          <div className="flex items-center gap-4">
            <div className="relative">
              <div className="h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center">
                <Icon className="h-6 w-6 text-primary" />
              </div>
              <Loader2 className="absolute -bottom-1 -right-1 h-5 w-5 text-primary animate-spin" />
            </div>
            <div>
              <h3 className="font-semibold">{title}</h3>
              <p className="text-sm text-muted-foreground">{description}</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Content skeleton */}
      <div className="space-y-6">
        {/* Introduction skeleton */}
        <div className="space-y-3">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-3/4" />
        </div>

        {/* Key concepts skeleton */}
        <div className="space-y-3">
          <Skeleton className="h-6 w-40" />
          <div className="grid gap-3 md:grid-cols-2">
            <Skeleton className="h-24" />
            <Skeleton className="h-24" />
          </div>
        </div>

        {/* Code block skeleton */}
        <div className="space-y-3">
          <Skeleton className="h-6 w-56" />
          <Skeleton className="h-32 rounded-lg" />
        </div>

        {/* More content */}
        <div className="space-y-3">
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-5/6" />
        </div>
      </div>

      {/* Info message */}
      <p className="text-center text-sm text-muted-foreground">
        Generowanie materialow dla &quot;{chapterTitle}&quot; moze zajac do 2 minut.
        <br />
        Nie odswiezaj strony.
      </p>
    </div>
  );
}
```

WAZNE:
- 3 fazy: searching -> generating -> saving
- Skeleton matching docelowy layout
- Warning o nie odswiezaniu strony
  </action>
  <verify>
    - `npx tsc --noEmit` - brak bledow
    - Eksportuje GeneratingState
  </verify>
  <done>GeneratingState gotowy</done>
</task>

<task type="auto">
  <name>Task 2: ChapterContent component z lazy generation</name>
  <files>src/components/materials/chapter-content.tsx</files>
  <action>
Stworz `src/components/materials/chapter-content.tsx`:

```typescript
'use client';

/**
 * Chapter Content Component
 *
 * Implements lazy generation pattern:
 * 1. Check if content exists
 * 2. If not, trigger generation
 * 3. Show loading state during generation
 * 4. Render content when ready
 */

import { useState, useEffect } from 'react';
import { ContentRenderer } from './content-renderer';
import { SourceList } from './source-list';
import { ToolCard } from './tool-card';
import { GeneratingState } from './generating-state';
import { Badge } from '@/components/ui/badge';
import { Clock, BookOpen, AlertCircle } from 'lucide-react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import type { SectionContent } from '@/types/materials';

interface ChapterData {
  id: string;
  title: string;
  description: string;
  topics: string[];
  estimatedMinutes: number;
}

interface ChapterContentProps {
  chapter: ChapterData;
  courseContext?: string;
  initialContent?: SectionContent | null;
}

type GenerationPhase = 'idle' | 'searching' | 'generating' | 'saving' | 'complete' | 'error';

export function ChapterContent({ chapter, courseContext, initialContent }: ChapterContentProps) {
  const [content, setContent] = useState<SectionContent | null>(initialContent || null);
  const [phase, setPhase] = useState<GenerationPhase>(initialContent ? 'complete' : 'idle');
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // If we already have content, skip generation
    if (content) {
      setPhase('complete');
      return;
    }

    // Start generation
    const generateContent = async () => {
      try {
        setPhase('searching');

        const response = await fetch('/api/materials/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chapterId: chapter.id,
            chapterTitle: chapter.title,
            chapterDescription: chapter.description,
            topics: chapter.topics,
            courseContext: courseContext || '',
          }),
        });

        setPhase('generating');

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to generate content');
        }

        setPhase('saving');
        const data = await response.json();

        if (!data.success || !data.content) {
          throw new Error('Invalid response from server');
        }

        setContent(data.content);
        setPhase('complete');
      } catch (err) {
        console.error('Content generation error:', err);
        setError(err instanceof Error ? err.message : 'Nieznany blad');
        setPhase('error');
      }
    };

    generateContent();
  }, [chapter, courseContext, content]);

  // Error state
  if (phase === 'error') {
    return (
      <Alert variant="destructive">
        <AlertCircle className="h-4 w-4" />
        <AlertTitle>Blad generowania</AlertTitle>
        <AlertDescription>
          {error || 'Nie udalo sie wygenerowac materialow. Sprobuj ponownie pozniej.'}
        </AlertDescription>
      </Alert>
    );
  }

  // Loading state
  if (phase !== 'complete' || !content) {
    return (
      <GeneratingState
        chapterTitle={chapter.title}
        phase={phase === 'idle' ? 'searching' : (phase as 'searching' | 'generating' | 'saving')}
      />
    );
  }

  // Content loaded - render
  return (
    <article className="space-y-8">
      {/* Metadata badges */}
      <div className="flex flex-wrap gap-2">
        <Badge variant="outline" className="flex items-center gap-1">
          <Clock className="h-3 w-3" />
          {content.estimatedReadingMinutes} min czytania
        </Badge>
        <Badge variant="outline" className="flex items-center gap-1">
          <BookOpen className="h-3 w-3" />
          {content.wordCount} slow
        </Badge>
        {chapter.topics.map((topic) => (
          <Badge key={topic} variant="secondary">
            {topic}
          </Badge>
        ))}
      </div>

      {/* Main content */}
      <ContentRenderer content={content.content} sources={content.sources} />

      {/* Tools section */}
      {content.tools && content.tools.length > 0 && (
        <section className="space-y-4">
          <h2 className="text-2xl font-semibold">Narzedzia</h2>
          <div className="grid gap-4 md:grid-cols-2">
            {content.tools.map((tool) => (
              <ToolCard key={tool.name} tool={tool} />
            ))}
          </div>
        </section>
      )}

      {/* External resources */}
      {content.externalResources && content.externalResources.length > 0 && (
        <section className="space-y-4">
          <h2 className="text-2xl font-semibold">Dodatkowe zasoby</h2>
          <ul className="space-y-2">
            {content.externalResources.map((resource) => (
              <li key={resource.url} className="flex items-center gap-2">
                <Badge variant="outline" className="text-xs">
                  {resource.language.toUpperCase()}
                </Badge>
                <Badge variant="secondary" className="text-xs capitalize">
                  {resource.type}
                </Badge>
                <a
                  href={resource.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-primary hover:underline"
                >
                  {resource.title}
                </a>
              </li>
            ))}
          </ul>
        </section>
      )}

      {/* Sources */}
      <SourceList sources={content.sources} />

      {/* Footer metadata */}
      <footer className="text-xs text-muted-foreground border-t pt-4">
        Wygenerowano: {new Date(content.generatedAt).toLocaleDateString('pl-PL')}
        {content.generationModel && <span> | Model: {content.generationModel}</span>}
        {content.version > 1 && <span> | Wersja: {content.version}</span>}
      </footer>
    </article>
  );
}
```

WAZNE:
- Lazy generation pattern: check -> generate -> display
- Phase tracking: searching -> generating -> saving -> complete
- Error handling z alert
- Metadata display (reading time, word count, topics)
- Wszystkie sekcje: content, tools, resources, sources
  </action>
  <verify>
    - `npx tsc --noEmit` - brak bledow
    - Eksportuje ChapterContent
  </verify>
  <done>ChapterContent z lazy generation gotowy</done>
</task>

<task type="auto">
  <name>Task 3: Chapter page</name>
  <files>src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx</files>
  <action>
Stworz `src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx`:

```typescript
/**
 * Chapter Detail Page
 *
 * Displays chapter content with learning materials.
 * Uses Suspense for streaming and lazy content generation.
 */

import { Suspense } from 'react';
import { notFound } from 'next/navigation';
import { getCourse } from '@/lib/dal/courses';
import { getSectionContent } from '@/lib/dal/materials';
import { ChapterContent } from '@/components/materials/chapter-content';
import { ChapterNavigation } from '@/components/curriculum/chapter-navigation';
import { GeneratingState } from '@/components/materials/generating-state';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface ChapterPageProps {
  params: Promise<{
    courseId: string;
    levelId: string;
    chapterId: string;
  }>;
}

export default async function ChapterPage({ params }: ChapterPageProps) {
  const { courseId, levelId, chapterId } = await params;

  // Get course with all nested data
  const course = await getCourse(courseId);

  if (!course) {
    notFound();
  }

  // Find the level
  const level = course.course_levels?.find((l) => l.id === levelId);
  if (!level) {
    notFound();
  }

  // Find the chapter
  const chapter = level.chapters?.find((c) => c.id === chapterId);
  if (!chapter) {
    notFound();
  }

  // Get existing content (may be null for lazy generation)
  const existingContent = await getSectionContent(chapterId);

  // Build course context for content generation
  const courseContext = `
Kurs: ${course.title}
Poziom: ${level.name} - ${level.description}
Grupa docelowa: ${course.target_audience || 'Nie okreslono'}
`.trim();

  return (
    <div className="container max-w-4xl py-8">
      {/* Back navigation */}
      <Button variant="ghost" asChild className="mb-6">
        <Link href={`/courses/${courseId}`}>
          <ArrowLeft className="mr-2 h-4 w-4" />
          Wr√≥c do kursu
        </Link>
      </Button>

      {/* Chapter header */}
      <header className="mb-8">
        <div className="text-sm text-muted-foreground mb-2">
          {level.name} &bull; Rozdzial {chapter.order_index}
        </div>
        <h1 className="text-3xl font-bold">{chapter.title}</h1>
        <p className="text-muted-foreground mt-2">{chapter.description}</p>
      </header>

      {/* Chapter content with Suspense */}
      <Suspense
        fallback={
          <GeneratingState
            chapterTitle={chapter.title}
            phase="searching"
          />
        }
      >
        <ChapterContent
          chapter={{
            id: chapter.id,
            title: chapter.title,
            description: chapter.description,
            topics: chapter.topics || [],
            estimatedMinutes: chapter.estimated_minutes,
          }}
          courseContext={courseContext}
          initialContent={existingContent}
        />
      </Suspense>

      {/* Chapter navigation */}
      <div className="mt-12">
        <ChapterNavigation
          courseId={courseId}
          levelId={levelId}
          currentChapterId={chapterId}
        />
      </div>
    </div>
  );
}
```

WAZNE:
- Server component pobiera course i chapter data
- Suspense dla streaming/lazy loading
- initialContent z getSectionContent (null jesli nie istnieje)
- courseContext budowany z course data dla lepszej generacji
- Back button do kursu
- ChapterNavigation dla prev/next
  </action>
  <verify>
    - `npx tsc --noEmit` - brak bledow
    - Page renderuje sie bez bledow
  </verify>
  <done>Chapter page gotowy</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` przechodzi bez bledow
2. Chapter page dostepny pod /courses/[courseId]/[levelId]/[chapterId]
3. Content generuje sie lazy gdy nie istnieje
4. Loading state pokazuje progress phases
5. Wygenerowany content renderuje markdown
</verification>

<success_criteria>
- [ ] GeneratingState pokazuje fazy generowania
- [ ] ChapterContent implementuje lazy generation
- [ ] Chapter page laczy wszystkie komponenty
- [ ] Suspense dla streaming
- [ ] Brak bledow TypeScript
</success_criteria>

<output>
After completion, create `.planning/phases/03-learning-materials/03-05-SUMMARY.md`
</output>
