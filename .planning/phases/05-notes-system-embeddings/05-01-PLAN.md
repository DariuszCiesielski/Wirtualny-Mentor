---
phase: 05-notes-system-embeddings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260131200001_notes_schema.sql
  - src/types/notes.ts
autonomous: true

must_haves:
  truths:
    - "Tabela notes istnieje w bazie danych z wszystkimi kolumnami"
    - "RLS policies chronią notatki użytkownika"
    - "Indeksy HNSW i GIN są utworzone dla wyszukiwania"
    - "TypeScript types są dostępne do importu"
  artifacts:
    - path: "supabase/migrations/20260131200001_notes_schema.sql"
      provides: "Notes database schema with pgvector and tsvector"
      contains: "CREATE TABLE notes"
    - path: "src/types/notes.ts"
      provides: "TypeScript types for notes"
      exports: ["Note", "CreateNoteInput", "NoteWithContext"]
  key_links:
    - from: "notes table"
      to: "courses table"
      via: "foreign key course_id"
      pattern: "REFERENCES courses\\(id\\)"
    - from: "notes table"
      to: "chapters table"
      via: "foreign key chapter_id"
      pattern: "REFERENCES chapters\\(id\\)"
---

<objective>
Utworzenie schematu bazy danych dla notatek uzytkownika z obsluga pgvector i tsvector.

Purpose: Notatki wymagaja przechowywania embeddingow wektorowych dla RAG chatbota oraz full-text search dla UI. Ten plan tworzy fundament danych.

Output: Migracja SQL + TypeScript types gotowe do uzycia przez DAL.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-notes-system-embeddings/05-RESEARCH.md

# Existing patterns to follow:
@supabase/migrations/20260130000001_courses_schema.sql
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes migration file</name>
  <files>supabase/migrations/20260131200001_notes_schema.sql</files>
  <action>
Utworz migracje SQL dla tabeli notes z nastepujaca struktura:

```sql
-- Enable pgvector extension (musi byc wlaczony w Supabase Dashboard)
CREATE EXTENSION IF NOT EXISTS vector;

-- Notes table
CREATE TABLE notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  course_id UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
  chapter_id UUID REFERENCES chapters(id) ON DELETE SET NULL,

  content TEXT NOT NULL,

  -- Vector embedding for RAG (halfvec = 50% storage savings)
  embedding halfvec(1536),

  -- Full-text search vector (auto-generated)
  fts tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,

  -- Track embedding model version for future re-embedding
  embedding_model TEXT DEFAULT 'text-embedding-3-small',

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Dodaj:
1. RLS policies (wzorzec EXISTS join z courses jak w innych tabelach)
2. HNSW index dla vector similarity search: `halfvec_cosine_ops`
3. GIN index dla full-text search
4. Trigger dla updated_at (reuse `update_updated_at_column()` z courses_schema)
5. Performance indexes na user_id, course_id, chapter_id

WAZNE:
- Uzyj `halfvec(1536)` NIE `vector(1536)` - 50% oszczednosci storage
- Uzyj 'simple' config dla tsvector (lepsze dla polskiego)
- RLS policy musi sprawdzac course ownership via EXISTS
  </action>
  <verify>
Plik istnieje i zawiera:
- CREATE TABLE notes z halfvec(1536)
- RLS policies z EXISTS join
- HNSW index
- GIN index
  </verify>
  <done>
Migracja SQL gotowa do uruchomienia w Supabase SQL Editor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types for notes</name>
  <files>src/types/notes.ts</files>
  <action>
Utworz plik z typami TypeScript dla notatek:

```typescript
/**
 * Notes Types - TypeScript types for user notes with embeddings
 *
 * Keep in sync with supabase/migrations/20260131200001_notes_schema.sql
 */

/**
 * Note - user note attached to a course/chapter
 */
export interface Note {
  id: string;
  user_id: string;
  course_id: string;
  chapter_id: string | null;
  content: string;
  embedding: number[] | null;
  embedding_model: string;
  created_at: string;
  updated_at: string;
}

/**
 * Note with context information (for display)
 */
export interface NoteWithContext extends Note {
  chapter_title?: string;
  level_name?: string;
  course_title?: string;
}

/**
 * Input for creating a note
 */
export interface CreateNoteInput {
  course_id: string;
  chapter_id?: string | null;
  content: string;
}

/**
 * Input for updating a note
 */
export interface UpdateNoteInput {
  content: string;
}

/**
 * Search result from vector similarity search
 */
export interface NoteSimilarityResult {
  id: string;
  content: string;
  similarity: number;
  chapter_id: string | null;
}

/**
 * Search result from full-text search
 */
export interface NoteSearchResult extends Note {
  rank?: number;
}
```

Eksportuj wszystkie typy z pliku.
  </action>
  <verify>
`npx tsc --noEmit src/types/notes.ts` - brak bledow
  </verify>
  <done>
TypeScript types dla notes dostepne do importu w calym projekcie.
  </done>
</task>

</tasks>

<verification>
1. Plik migracji zawiera CREATE TABLE notes z halfvec(1536)
2. Plik migracji zawiera RLS policies z EXISTS join
3. Plik migracji zawiera CREATE INDEX USING hnsw
4. Plik migracji zawiera CREATE INDEX USING gin
5. TypeScript types kompiluja sie bez bledow
6. Types eksportuja Note, CreateNoteInput, NoteWithContext, NoteSimilarityResult
</verification>

<success_criteria>
- Migration file ready for Supabase SQL Editor
- TypeScript types available for import
- Schema follows existing project patterns (RLS via EXISTS, triggers for updated_at)
- halfvec used instead of vector (50% storage savings)
</success_criteria>

<output>
After completion, create `.planning/phases/05-notes-system-embeddings/05-01-SUMMARY.md`
</output>
