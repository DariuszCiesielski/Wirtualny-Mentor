---
phase: 05-notes-system-embeddings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/embeddings.ts
autonomous: true

must_haves:
  truths:
    - "Funkcja generateEmbedding zwraca embedding dla tekstu"
    - "Funkcja generateEmbeddings zwraca embeddingi dla wielu tekstow"
    - "Funkcje uzywaja text-embedding-3-small z providers.ts"
  artifacts:
    - path: "src/lib/ai/embeddings.ts"
      provides: "Embedding generation functions"
      exports: ["generateEmbedding", "generateEmbeddings"]
  key_links:
    - from: "src/lib/ai/embeddings.ts"
      to: "@ai-sdk/openai"
      via: "import openai"
      pattern: "import.*openai.*from.*@ai-sdk/openai"
    - from: "src/lib/ai/embeddings.ts"
      to: "ai"
      via: "embed/embedMany functions"
      pattern: "import.*embed.*from.*ai"
---

<objective>
Utworzenie wrapper functions dla generowania embeddingow z AI SDK.

Purpose: DAL i Server Actions beda potrzebowaly generowac embeddingi przy tworzeniu/edycji notatek. Ten plan dostarcza reuzywalne funkcje.

Output: Modul embeddings.ts z funkcjami embed/embedMany gotowymi do uzycia.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-notes-system-embeddings/05-RESEARCH.md

# Existing AI patterns:
@src/lib/ai/providers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embeddings module</name>
  <files>src/lib/ai/embeddings.ts</files>
  <action>
Utworz modul z funkcjami do generowania embeddingow:

```typescript
/**
 * Embedding Generation - AI SDK wrapper for text embeddings
 *
 * Uses OpenAI text-embedding-3-small (1536 dimensions)
 * Configured in providers.ts as MODEL_CONFIG.embedding
 *
 * Source: https://ai-sdk.dev/docs/ai-sdk-core/embeddings
 */

import { embed, embedMany, cosineSimilarity } from 'ai';
import { openai } from '@ai-sdk/openai';

// Model configuration - matches providers.ts
const EMBEDDING_MODEL = openai.embedding('text-embedding-3-small');
const EMBEDDING_DIMENSIONS = 1536;

/**
 * Generate embedding for a single text
 *
 * @param text - Text to embed
 * @returns Float array of 1536 dimensions
 */
export async function generateEmbedding(text: string): Promise<number[]> {
  const { embedding, usage } = await embed({
    model: EMBEDDING_MODEL,
    value: text,
  });

  // Log usage for cost tracking (optional)
  console.log(`[Embedding] Tokens: ${usage.tokens}`);

  return embedding;
}

/**
 * Generate embeddings for multiple texts (batch)
 *
 * More efficient than calling generateEmbedding in a loop.
 * Use for re-indexing or bulk operations.
 *
 * @param texts - Array of texts to embed
 * @returns Array of float arrays (1536 dimensions each)
 */
export async function generateEmbeddings(texts: string[]): Promise<number[][]> {
  if (texts.length === 0) {
    return [];
  }

  const { embeddings, usage } = await embedMany({
    model: EMBEDDING_MODEL,
    values: texts,
  });

  console.log(`[Embedding Batch] Texts: ${texts.length}, Tokens: ${usage.tokens}`);

  return embeddings;
}

/**
 * Calculate cosine similarity between two embeddings
 *
 * @param a - First embedding
 * @param b - Second embedding
 * @returns Similarity score (0 to 1, higher = more similar)
 */
export function calculateSimilarity(a: number[], b: number[]): number {
  return cosineSimilarity(a, b);
}

/**
 * Embedding model identifier for tracking version drift
 */
export const EMBEDDING_MODEL_ID = 'text-embedding-3-small';

/**
 * Embedding dimensions for type checking
 */
export { EMBEDDING_DIMENSIONS };
```

WAZNE:
- Uzywaj `openai.embedding('text-embedding-3-small')` NIE `MODEL_CONFIG.embedding` - embed() wymaga EmbeddingModel
- Eksportuj EMBEDDING_MODEL_ID dla zapisywania w DB (sledzenie version drift)
- Loguj usage dla cost tracking
  </action>
  <verify>
1. `npx tsc --noEmit src/lib/ai/embeddings.ts` - brak bledow
2. Sprawdz czy importy sa poprawne (embed, embedMany, cosineSimilarity z 'ai')
  </verify>
  <done>
Modul embeddings.ts gotowy do uzycia przez DAL i Server Actions.
  </done>
</task>

</tasks>

<verification>
1. Plik eksportuje generateEmbedding, generateEmbeddings, calculateSimilarity
2. Plik eksportuje EMBEDDING_MODEL_ID, EMBEDDING_DIMENSIONS
3. TypeScript kompiluje sie bez bledow
4. Funkcje uzywaja AI SDK (embed/embedMany z 'ai')
</verification>

<success_criteria>
- Embedding functions available for import
- Uses AI SDK pattern from RESEARCH.md
- Exports model ID for version tracking
- TypeScript types correct
</success_criteria>

<output>
After completion, create `.planning/phases/05-notes-system-embeddings/05-02-SUMMARY.md`
</output>
