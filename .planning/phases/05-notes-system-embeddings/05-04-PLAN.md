---
phase: 05-notes-system-embeddings
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/components/notes/note-editor.tsx
  - src/components/notes/note-card.tsx
  - src/components/notes/notes-list.tsx
  - src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Uzytkownik widzi pole do tworzenia notatki na stronie rozdzialu"
    - "Uzytkownik moze zapisac notatke klikajac przycisk"
    - "Uzytkownik widzi liste swoich notatek dla rozdzialu"
    - "Uzytkownik moze edytowac istniejaca notatke"
    - "Uzytkownik moze usunac notatke"
  artifacts:
    - path: "src/components/notes/note-editor.tsx"
      provides: "Note creation/editing form"
      min_lines: 50
    - path: "src/components/notes/note-card.tsx"
      provides: "Single note display with actions"
      min_lines: 40
    - path: "src/components/notes/notes-list.tsx"
      provides: "List of notes for chapter"
      min_lines: 30
  key_links:
    - from: "note-editor.tsx"
      to: "actions.ts"
      via: "form action"
      pattern: "action=.*createNoteAction|updateNoteAction"
    - from: "notes-list.tsx"
      to: "dal/notes.ts"
      via: "server component data"
      pattern: "getNotes|getNotesWithContext"
---

<objective>
Implementacja komponentow UI dla systemu notatek na stronie rozdzialu.

Purpose: Uzytkownik musi moc tworzyc, przegladac, edytowac i usuwac notatki podczas nauki. Ten plan dostarcza kompletny UI.

Output: Komponenty notes/* zintegrowane ze strona rozdzialu.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-notes-system-embeddings/05-RESEARCH.md

# Dependencies from this phase:
@src/lib/dal/notes.ts
@src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions.ts
@src/types/notes.ts

# Existing patterns:
@src/components/materials/chapter-content.tsx
@src/components/ui/textarea.tsx
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create note-editor component</name>
  <files>src/components/notes/note-editor.tsx</files>
  <action>
Utworz komponent note-editor.tsx dla tworzenia i edycji notatek:

```typescript
'use client';

import { useState, useTransition } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Loader2, Save, X } from 'lucide-react';
import { createNoteAction, updateNoteAction } from '@/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions';
import type { Note } from '@/types/notes';

interface NoteEditorProps {
  courseId: string;
  chapterId: string;
  /** If provided, edit mode instead of create */
  note?: Note;
  /** Callback after successful save */
  onSave?: (note: Note) => void;
  /** Callback to cancel edit mode */
  onCancel?: () => void;
}

export function NoteEditor({
  courseId,
  chapterId,
  note,
  onSave,
  onCancel,
}: NoteEditorProps) {
  const [content, setContent] = useState(note?.content ?? '');
  const [isPending, startTransition] = useTransition();
  const [error, setError] = useState<string | null>(null);

  const isEditMode = !!note;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    if (!content.trim()) {
      setError('Notatka nie moze byc pusta');
      return;
    }

    const formData = new FormData();
    formData.set('content', content);
    formData.set('courseId', courseId);
    formData.set('chapterId', chapterId);

    if (isEditMode && note) {
      formData.set('noteId', note.id);
    }

    startTransition(async () => {
      const result = isEditMode
        ? await updateNoteAction(formData)
        : await createNoteAction(formData);

      if ('error' in result && result.error) {
        setError(result.error);
        return;
      }

      if ('data' in result && result.data) {
        onSave?.(result.data);
        if (!isEditMode) {
          setContent(''); // Clear after create
        }
      }
    });
  };

  return (
    <Card>
      <form onSubmit={handleSubmit}>
        <CardContent className="pt-4">
          <Textarea
            placeholder="Dodaj notatke do tego rozdzialu..."
            value={content}
            onChange={(e) => setContent(e.target.value)}
            rows={4}
            disabled={isPending}
            className="resize-none"
          />
          {error && (
            <p className="text-sm text-destructive mt-2">{error}</p>
          )}
        </CardContent>
        <CardFooter className="flex justify-end gap-2">
          {isEditMode && onCancel && (
            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={onCancel}
              disabled={isPending}
            >
              <X className="h-4 w-4 mr-1" />
              Anuluj
            </Button>
          )}
          <Button
            type="submit"
            size="sm"
            disabled={isPending || !content.trim()}
          >
            {isPending ? (
              <Loader2 className="h-4 w-4 mr-1 animate-spin" />
            ) : (
              <Save className="h-4 w-4 mr-1" />
            )}
            {isEditMode ? 'Zapisz zmiany' : 'Zapisz notatke'}
          </Button>
        </CardFooter>
      </form>
    </Card>
  );
}
```

WAZNE:
- useTransition dla pending state
- Obsluga error z Server Action
- Clear content po successful create (nie edit)
- Disabled state podczas pending
  </action>
  <verify>
`npx tsc --noEmit src/components/notes/note-editor.tsx` - brak bledow
  </verify>
  <done>
Komponent note-editor gotowy do tworzenia i edycji notatek.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create note-card component</name>
  <files>src/components/notes/note-card.tsx</files>
  <action>
Utworz komponent note-card.tsx do wyswietlania pojedynczej notatki:

```typescript
'use client';

import { useState, useTransition } from 'react';
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Pencil, Trash2, Loader2 } from 'lucide-react';
import { deleteNoteAction } from '@/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/actions';
import { NoteEditor } from './note-editor';
import type { Note } from '@/types/notes';

interface NoteCardProps {
  note: Note;
  courseId: string;
  chapterId: string;
  onDelete?: () => void;
  onUpdate?: (note: Note) => void;
}

export function NoteCard({
  note,
  courseId,
  chapterId,
  onDelete,
  onUpdate,
}: NoteCardProps) {
  const [isEditing, setIsEditing] = useState(false);
  const [isPending, startTransition] = useTransition();

  const handleDelete = () => {
    if (!confirm('Czy na pewno chcesz usunac te notatke?')) {
      return;
    }

    const formData = new FormData();
    formData.set('noteId', note.id);
    formData.set('courseId', courseId);

    startTransition(async () => {
      const result = await deleteNoteAction(formData);

      if ('error' in result && result.error) {
        alert(result.error);
        return;
      }

      onDelete?.();
    });
  };

  const handleUpdate = (updatedNote: Note) => {
    setIsEditing(false);
    onUpdate?.(updatedNote);
  };

  if (isEditing) {
    return (
      <NoteEditor
        courseId={courseId}
        chapterId={chapterId}
        note={note}
        onSave={handleUpdate}
        onCancel={() => setIsEditing(false)}
      />
    );
  }

  return (
    <Card>
      <CardContent className="pt-4">
        <p className="whitespace-pre-wrap text-sm">{note.content}</p>
      </CardContent>
      <CardFooter className="flex justify-between items-center">
        <span className="text-xs text-muted-foreground">
          {new Date(note.created_at).toLocaleDateString('pl-PL', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })}
        </span>
        <div className="flex gap-1">
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setIsEditing(true)}
            disabled={isPending}
          >
            <Pencil className="h-4 w-4" />
            <span className="sr-only">Edytuj</span>
          </Button>
          <Button
            variant="ghost"
            size="icon"
            onClick={handleDelete}
            disabled={isPending}
          >
            {isPending ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <Trash2 className="h-4 w-4" />
            )}
            <span className="sr-only">Usun</span>
          </Button>
        </div>
      </CardFooter>
    </Card>
  );
}
```

WAZNE:
- Toggle miedzy view mode i edit mode
- Confirm dialog przed usunieciem
- Polish date formatting
- whitespace-pre-wrap dla zachowania formatowania
  </action>
  <verify>
`npx tsc --noEmit src/components/notes/note-card.tsx` - brak bledow
  </verify>
  <done>
Komponent note-card gotowy do wyswietlania i edycji pojedynczej notatki.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create notes-list component and integrate with chapter page</name>
  <files>src/components/notes/notes-list.tsx, src/app/(dashboard)/courses/[courseId]/[levelId]/[chapterId]/page.tsx</files>
  <action>
1. Utworz notes-list.tsx:

```typescript
'use client';

import { useState } from 'react';
import { NoteEditor } from './note-editor';
import { NoteCard } from './note-card';
import { StickyNote } from 'lucide-react';
import type { Note } from '@/types/notes';

interface NotesListProps {
  courseId: string;
  chapterId: string;
  initialNotes: Note[];
}

export function NotesList({ courseId, chapterId, initialNotes }: NotesListProps) {
  const [notes, setNotes] = useState<Note[]>(initialNotes);

  const handleCreate = (newNote: Note) => {
    setNotes((prev) => [newNote, ...prev]);
  };

  const handleUpdate = (updatedNote: Note) => {
    setNotes((prev) =>
      prev.map((n) => (n.id === updatedNote.id ? updatedNote : n))
    );
  };

  const handleDelete = (noteId: string) => {
    setNotes((prev) => prev.filter((n) => n.id !== noteId));
  };

  return (
    <section className="space-y-4">
      <div className="flex items-center gap-2">
        <StickyNote className="h-5 w-5" />
        <h2 className="text-xl font-semibold">Notatki</h2>
        <span className="text-sm text-muted-foreground">
          ({notes.length})
        </span>
      </div>

      <NoteEditor
        courseId={courseId}
        chapterId={chapterId}
        onSave={handleCreate}
      />

      {notes.length > 0 && (
        <div className="space-y-3">
          {notes.map((note) => (
            <NoteCard
              key={note.id}
              note={note}
              courseId={courseId}
              chapterId={chapterId}
              onUpdate={handleUpdate}
              onDelete={() => handleDelete(note.id)}
            />
          ))}
        </div>
      )}

      {notes.length === 0 && (
        <p className="text-sm text-muted-foreground text-center py-4">
          Brak notatek. Dodaj pierwsza notatke powyzej.
        </p>
      )}
    </section>
  );
}
```

2. Zaktualizuj chapter page.tsx zeby pobierac notatki i renderowac NotesList:

W istniejacym pliku page.tsx:
- Zaimportuj `getNotes` z `@/lib/dal/notes`
- Zaimportuj `NotesList` z `@/components/notes/notes-list`
- W funkcji page (server component) pobierz notatki:
  ```typescript
  const notes = await getNotes(user.id, courseId, chapterId);
  ```
- Dodaj NotesList na dole strony, pod ChapterContent i ewentualnym quizem:
  ```tsx
  <NotesList
    courseId={courseId}
    chapterId={chapterId}
    initialNotes={notes}
  />
  ```

WAZNE:
- NotesList jest client component (uzywa useState)
- initialNotes sa pobierane server-side i przekazywane jako prop
- Optimistic updates: dodawanie/usuwanie bez czekania na revalidation
  </action>
  <verify>
1. `npx tsc --noEmit src/components/notes/notes-list.tsx` - brak bledow
2. Strona chapter powinna zawierac import NotesList i renderowac go
  </verify>
  <done>
System notatek zintegrowany ze strona rozdzialu - uzytkownik moze tworzyc, przegladac, edytowac i usuwac notatki.
  </done>
</task>

</tasks>

<verification>
1. note-editor.tsx eksportuje NoteEditor
2. note-card.tsx eksportuje NoteCard
3. notes-list.tsx eksportuje NotesList
4. Chapter page pobiera notatki server-side i renderuje NotesList
5. TypeScript kompiluje sie bez bledow
6. UI pokazuje editor + liste notatek
</verification>

<success_criteria>
- User can create notes via NoteEditor
- User can view notes in NotesList
- User can edit notes (inline)
- User can delete notes (with confirmation)
- Notes are persisted and survive page refresh
- Optimistic UI updates for better UX
</success_criteria>

<output>
After completion, create `.planning/phases/05-notes-system-embeddings/05-04-SUMMARY.md`
</output>
