---
phase: 05-notes-system-embeddings
plan: 05
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/components/notes/notes-search.tsx
  - src/app/(dashboard)/courses/[courseId]/notes/page.tsx
  - src/app/(dashboard)/courses/[courseId]/notes/actions.ts
autonomous: true

must_haves:
  truths:
    - "Uzytkownik moze przegladac wszystkie notatki dla kursu"
    - "Uzytkownik moze wyszukiwac notatki (full-text search)"
    - "Wyniki wyszukiwania pokazuja kontekst (rozdzial)"
    - "Uzytkownik moze kliknac notatke i przejsc do rozdzialu"
  artifacts:
    - path: "src/components/notes/notes-search.tsx"
      provides: "Search input with results"
      min_lines: 60
    - path: "src/app/(dashboard)/courses/[courseId]/notes/page.tsx"
      provides: "All notes page with search"
      min_lines: 40
  key_links:
    - from: "notes-search.tsx"
      to: "actions.ts"
      via: "server action"
      pattern: "searchNotesAction"
    - from: "page.tsx"
      to: "dal/notes.ts"
      via: "getNotesWithContext"
      pattern: "getNotesWithContext"
---

<objective>
Implementacja strony wszystkich notatek z wyszukiwaniem full-text.

Purpose: Uzytkownik potrzebuje przegladac wszystkie swoje notatki w kursie i szybko wyszukiwac po tresci. Ten plan dostarcza UI wyszukiwania.

Output: Strona /courses/[courseId]/notes z lista notatek i wyszukiwarka.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-notes-system-embeddings/05-RESEARCH.md

# Dependencies from this phase:
@src/lib/dal/notes.ts
@src/types/notes.ts
@src/components/notes/note-card.tsx

# Existing patterns:
@src/components/ui/input.tsx
@src/app/(dashboard)/courses/[courseId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notes search component</name>
  <files>src/components/notes/notes-search.tsx</files>
  <action>
Utworz komponent notes-search.tsx z wyszukiwarka full-text:

```typescript
'use client';

import { useState, useTransition, useCallback } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Search, Loader2, X } from 'lucide-react';
import { searchNotesAction } from '@/app/(dashboard)/courses/[courseId]/notes/actions';
import type { NoteWithContext } from '@/types/notes';

interface NotesSearchProps {
  courseId: string;
  onResults: (notes: NoteWithContext[]) => void;
  onClear: () => void;
}

export function NotesSearch({ courseId, onResults, onClear }: NotesSearchProps) {
  const [query, setQuery] = useState('');
  const [isPending, startTransition] = useTransition();

  const handleSearch = useCallback(() => {
    if (!query.trim()) {
      onClear();
      return;
    }

    const formData = new FormData();
    formData.set('courseId', courseId);
    formData.set('query', query.trim());

    startTransition(async () => {
      const result = await searchNotesAction(formData);

      if ('error' in result && result.error) {
        console.error('Search error:', result.error);
        return;
      }

      if ('data' in result && result.data) {
        onResults(result.data);
      }
    });
  }, [courseId, query, onResults, onClear]);

  const handleClear = () => {
    setQuery('');
    onClear();
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSearch();
    }
  };

  return (
    <div className="flex gap-2">
      <div className="relative flex-1">
        <Input
          placeholder="Szukaj w notatkach..."
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          onKeyDown={handleKeyDown}
          disabled={isPending}
          className="pr-8"
        />
        {query && (
          <Button
            variant="ghost"
            size="icon"
            className="absolute right-1 top-1/2 -translate-y-1/2 h-6 w-6"
            onClick={handleClear}
          >
            <X className="h-4 w-4" />
            <span className="sr-only">Wyczysc</span>
          </Button>
        )}
      </div>
      <Button onClick={handleSearch} disabled={isPending || !query.trim()}>
        {isPending ? (
          <Loader2 className="h-4 w-4 animate-spin" />
        ) : (
          <Search className="h-4 w-4" />
        )}
        <span className="sr-only">Szukaj</span>
      </Button>
    </div>
  );
}
```

WAZNE:
- Enter key triggers search
- Clear button when query exists
- onResults callback dla wynikow
- onClear callback do powrotu do wszystkich notatek
  </action>
  <verify>
`npx tsc --noEmit src/components/notes/notes-search.tsx` - brak bledow
  </verify>
  <done>
Komponent wyszukiwarki notatek gotowy.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notes page and server action</name>
  <files>src/app/(dashboard)/courses/[courseId]/notes/page.tsx, src/app/(dashboard)/courses/[courseId]/notes/actions.ts</files>
  <action>
1. Utworz actions.ts dla wyszukiwania:

```typescript
'use server';

import { createClient } from '@/lib/supabase/server';
import { searchNotesFulltext, getNotesWithContext } from '@/lib/dal/notes';
import type { NoteWithContext } from '@/types/notes';

/**
 * Search notes with full-text search
 */
export async function searchNotesAction(formData: FormData) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return { error: 'Unauthorized' };
  }

  const courseId = formData.get('courseId') as string;
  const query = formData.get('query') as string;

  if (!courseId || !query) {
    return { error: 'Missing parameters' };
  }

  try {
    // Use full-text search
    const notes = await searchNotesFulltext(user.id, courseId, query);

    // Get context for found notes
    const allNotes = await getNotesWithContext(user.id, courseId);
    const notesWithContext = notes.map((note) => {
      const contextNote = allNotes.find((n) => n.id === note.id);
      return contextNote || note;
    });

    return { data: notesWithContext as NoteWithContext[] };
  } catch (error) {
    console.error('Search notes error:', error);
    return {
      error: error instanceof Error ? error.message : 'Failed to search notes',
    };
  }
}
```

2. Utworz page.tsx dla strony notatek:

```typescript
import { redirect } from 'next/navigation';
import Link from 'next/link';
import { createClient } from '@/lib/supabase/server';
import { getNotesWithContext } from '@/lib/dal/notes';
import { getCourse } from '@/lib/dal/courses';
import { NotesPageClient } from './notes-page-client';
import { Button } from '@/components/ui/button';
import { ArrowLeft, StickyNote } from 'lucide-react';

interface NotesPageProps {
  params: Promise<{ courseId: string }>;
}

export default async function NotesPage({ params }: NotesPageProps) {
  const { courseId } = await params;

  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  const course = await getCourse(courseId);

  if (!course) {
    redirect('/courses');
  }

  const notes = await getNotesWithContext(user.id, courseId);

  return (
    <div className="container max-w-4xl py-8 space-y-6">
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link href={`/courses/${courseId}`}>
            <ArrowLeft className="h-4 w-4" />
            <span className="sr-only">Wróć do kursu</span>
          </Link>
        </Button>
        <div className="flex items-center gap-2">
          <StickyNote className="h-6 w-6" />
          <h1 className="text-2xl font-bold">Notatki</h1>
        </div>
      </div>

      <p className="text-muted-foreground">
        Wszystkie notatki z kursu "{course.title}"
      </p>

      <NotesPageClient courseId={courseId} initialNotes={notes} />
    </div>
  );
}
```

3. Utworz notes-page-client.tsx (client component dla interaktywnosci):

```typescript
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { NotesSearch } from '@/components/notes/notes-search';
import { Card, CardContent, CardFooter, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { ChevronRight } from 'lucide-react';
import type { NoteWithContext } from '@/types/notes';

interface NotesPageClientProps {
  courseId: string;
  initialNotes: NoteWithContext[];
}

export function NotesPageClient({ courseId, initialNotes }: NotesPageClientProps) {
  const [notes, setNotes] = useState<NoteWithContext[]>(initialNotes);
  const [isSearching, setIsSearching] = useState(false);

  const handleSearchResults = (results: NoteWithContext[]) => {
    setNotes(results);
    setIsSearching(true);
  };

  const handleClear = () => {
    setNotes(initialNotes);
    setIsSearching(false);
  };

  return (
    <div className="space-y-6">
      <NotesSearch
        courseId={courseId}
        onResults={handleSearchResults}
        onClear={handleClear}
      />

      {isSearching && (
        <p className="text-sm text-muted-foreground">
          Znaleziono {notes.length} notatek
        </p>
      )}

      {notes.length === 0 ? (
        <p className="text-center text-muted-foreground py-8">
          {isSearching
            ? 'Brak wyników wyszukiwania'
            : 'Brak notatek w tym kursie. Przejdź do rozdziału i dodaj pierwszą notatkę.'}
        </p>
      ) : (
        <div className="space-y-4">
          {notes.map((note) => (
            <NoteContextCard key={note.id} note={note} courseId={courseId} />
          ))}
        </div>
      )}
    </div>
  );
}

function NoteContextCard({
  note,
  courseId,
}: {
  note: NoteWithContext;
  courseId: string;
}) {
  // Build link to chapter if available
  const chapterLink = note.chapter_id
    ? `/courses/${courseId}/${note.level_name ? encodeURIComponent(note.level_name) : 'level'}/${note.chapter_id}`
    : null;

  return (
    <Card>
      <CardHeader className="pb-2">
        <div className="flex items-center gap-2 flex-wrap">
          {note.level_name && (
            <Badge variant="outline">{note.level_name}</Badge>
          )}
          {note.chapter_title && (
            <Badge variant="secondary">{note.chapter_title}</Badge>
          )}
        </div>
      </CardHeader>
      <CardContent>
        <p className="whitespace-pre-wrap text-sm line-clamp-3">
          {note.content}
        </p>
      </CardContent>
      <CardFooter className="flex justify-between items-center">
        <span className="text-xs text-muted-foreground">
          {new Date(note.created_at).toLocaleDateString('pl-PL', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
          })}
        </span>
        {chapterLink && (
          <Link
            href={chapterLink}
            className="text-sm text-primary hover:underline flex items-center gap-1"
          >
            Przejdź do rozdziału
            <ChevronRight className="h-4 w-4" />
          </Link>
        )}
      </CardFooter>
    </Card>
  );
}
```

Utworz takze plik src/app/(dashboard)/courses/[courseId]/notes/notes-page-client.tsx z komponentem NotesPageClient.

WAZNE:
- Server component page.tsx pobiera dane
- Client component NotesPageClient zarzadza stanem wyszukiwania
- Link do rozdzialu pozwala przejsc do kontekstu notatki
- line-clamp-3 dla dlugich notatek
  </action>
  <verify>
1. `npx tsc --noEmit src/app/\(dashboard\)/courses/\[courseId\]/notes/page.tsx` - brak bledow
2. `npx tsc --noEmit src/app/\(dashboard\)/courses/\[courseId\]/notes/actions.ts` - brak bledow
  </verify>
  <done>
Strona wszystkich notatek z wyszukiwaniem gotowa.
  </done>
</task>

</tasks>

<verification>
1. notes-search.tsx eksportuje NotesSearch
2. page.tsx pobiera notatki server-side i renderuje NotesPageClient
3. actions.ts eksportuje searchNotesAction
4. Wyszukiwanie zwraca wyniki z kontekstem (chapter_title, level_name)
5. Link do rozdzialu dziala
6. TypeScript kompiluje sie bez bledow
</verification>

<success_criteria>
- User can view all notes for a course
- User can search notes with full-text search
- Search results show context (chapter, level)
- User can click to navigate to chapter
- Empty states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/05-notes-system-embeddings/05-05-SUMMARY.md`
</output>
