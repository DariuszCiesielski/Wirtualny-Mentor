---
phase: 06-mentor-chatbot
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/chat/mentor/route.ts
autonomous: true

must_haves:
  truths:
    - "API endpoint streamuje odpowiedzi w czasie rzeczywistym"
    - "Endpoint wymaga autentykacji"
    - "Endpoint weryfikuje ownership kursu"
    - "Tool calling dziala z searchNotes"
  artifacts:
    - path: "src/app/api/chat/mentor/route.ts"
      provides: "Streaming chat endpoint for mentor"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/chat/mentor/route.ts"
      to: "src/lib/ai/providers.ts"
      via: "import getModel"
      pattern: "getModel.*mentor"
    - from: "src/app/api/chat/mentor/route.ts"
      to: "src/lib/supabase/server.ts"
      via: "auth verification"
      pattern: "getUser"
---

<objective>
Create streaming chat API endpoint for mentor chatbot with auth, course verification, and tool calling.

Purpose: Backend endpoint that processes chat messages, integrates RAG tools, and streams responses.
Output: /api/chat/mentor POST endpoint with Edge runtime.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mentor-chatbot/06-RESEARCH.md

# Existing patterns
@src/app/api/curriculum/clarify/route.ts
@src/lib/ai/providers.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mentor chat API route</name>
  <files>src/app/api/chat/mentor/route.ts</files>
  <action>
Create streaming chat endpoint:

1. Create directory `src/app/api/chat/mentor/`
2. Create `route.ts` with POST handler

**Imports:**
```typescript
import { streamText, stepCountIs, convertToModelMessages } from 'ai';
import { getModel } from '@/lib/ai/providers';
import { MENTOR_SYSTEM_PROMPT } from '@/lib/ai/mentor/prompts';
import { createSearchNotesTool } from '@/lib/ai/mentor/tools';
import { createClient } from '@/lib/supabase/server';
import { z } from 'zod';
```

**Request validation:**
```typescript
const requestSchema = z.object({
  messages: z.array(z.any()),
  courseId: z.string().uuid(),
});
```

**POST handler flow:**
1. Parse and validate request body with requestSchema
2. Auth check: `const { data: { user } } = await supabase.auth.getUser()`
3. Return 401 if no user
4. Verify course ownership: query courses table for id + user_id
5. Return 404 if course not found
6. Create tool: `createSearchNotesTool({ userId: user.id, courseId })`
7. Call streamText with:
   - model: `getModel('mentor')` (Claude Sonnet 4)
   - system: MENTOR_SYSTEM_PROMPT
   - messages: `await convertToModelMessages(messages)`
   - tools: `{ searchNotes }`
   - stopWhen: `stepCountIs(3)` (max 3 tool calls per turn)
8. Return `result.toUIMessageStreamResponse()`

**Runtime config:**
```typescript
export const runtime = 'edge';
export const maxDuration = 30;
```

Pattern: See 06-RESEARCH.md "Chat Route Handler with Auth" for exact implementation.

NOTE: Use imports from 06-01 (prompts.ts, tools.ts) - they will exist when this runs (both Wave 1).
  </action>
  <verify>
    - File exists at src/app/api/chat/mentor/route.ts
    - POST function is exported
    - Uses streamText with getModel('mentor')
    - Has auth check with getUser()
    - Has course ownership verification
    - Edge runtime exported
  </verify>
  <done>Streaming chat endpoint deployed at /api/chat/mentor with auth, course verification, and tool calling</done>
</task>

</tasks>

<verification>
After task:
1. TypeScript compiles: `npx tsc --noEmit`
2. File structure correct: src/app/api/chat/mentor/route.ts
3. POST handler exported
4. Uses correct model: getModel('mentor')
</verification>

<success_criteria>
- POST /api/chat/mentor endpoint exists
- Requires authentication (401 for unauthenticated)
- Verifies course ownership (404 for wrong user)
- Streams responses using AI SDK
- Tool calling enabled with searchNotes
</success_criteria>

<output>
After completion, create `.planning/phases/06-mentor-chatbot/06-02-SUMMARY.md`
</output>
