---
phase: 06-mentor-chatbot
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/app/(dashboard)/courses/[courseId]/chat/page.tsx
  - src/app/(dashboard)/courses/[courseId]/chat/components/mentor-chat.tsx
autonomous: true

must_haves:
  truths:
    - "Uzytkownik moze zadawac pytania o temat nauki"
    - "Odpowiedzi sa streamowane w czasie rzeczywistym"
    - "Chat UI pokazuje wiadomosc powitalna"
    - "Uzytkownik widzi loading state podczas generowania"
    - "Uzytkownik moze zatrzymac generowanie"
  artifacts:
    - path: "src/app/(dashboard)/courses/[courseId]/chat/page.tsx"
      provides: "Chat page server component"
      min_lines: 20
    - path: "src/app/(dashboard)/courses/[courseId]/chat/components/mentor-chat.tsx"
      provides: "Chat UI client component"
      exports: ["MentorChat"]
  key_links:
    - from: "src/app/(dashboard)/courses/[courseId]/chat/components/mentor-chat.tsx"
      to: "/api/chat/mentor"
      via: "DefaultChatTransport"
      pattern: "api.*chat.*mentor"
    - from: "src/app/(dashboard)/courses/[courseId]/chat/page.tsx"
      to: "src/lib/dal/courses.ts"
      via: "getCourse"
      pattern: "getCourse"
---

<objective>
Create chat page and UI component for mentor chatbot with streaming messages and course context.

Purpose: User-facing chat interface to interact with the Socratic mentor.
Output: Chat page at /courses/[courseId]/chat with real-time streaming UI.
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-mentor-chatbot/06-RESEARCH.md

# Existing patterns
@src/components/curriculum/clarifying-chat.tsx
@src/app/(dashboard)/courses/[courseId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MentorChat client component</name>
  <files>src/app/(dashboard)/courses/[courseId]/chat/components/mentor-chat.tsx</files>
  <action>
Create chat UI client component:

1. Create directory `src/app/(dashboard)/courses/[courseId]/chat/components/`
2. Create `mentor-chat.tsx` with 'use client' directive

**Props:**
```typescript
interface MentorChatProps {
  courseId: string;
  courseTitle: string;
}
```

**Implementation using existing clarifying-chat.tsx pattern:**

1. **Transport setup:**
```typescript
const transport = useMemo(
  () => new DefaultChatTransport({
    api: '/api/chat/mentor',
    body: { courseId },
  }),
  [courseId]
);
```

2. **useChat hook:**
```typescript
const { messages, sendMessage, status, error, stop } = useChat({
  transport,
  initialMessages: [{
    id: 'welcome',
    role: 'assistant',
    parts: [{ type: 'text', text: `Czesc! Jestem Twoim mentorem dla kursu "${courseTitle}".\n\nJestem tutaj, zeby pomoc Ci sie uczyc - ale nie przez dawanie gotowych odpowiedzi! Zamiast tego bede zadawal pytania, ktore naprowadza Cie na rozwiazanie.\n\nO czym chcesz porozmawiaÄ‡?` }],
  }],
});
```

3. **State derived:**
```typescript
const isLoading = status === 'streaming' || status === 'submitted';
```

4. **UI components (use existing shadcn):**
- Card for message bubbles
- Textarea for input (multiline)
- Button with Send icon
- Loader2 for loading state
- Bot/User icons from lucide-react

5. **Features:**
- Auto-scroll to bottom on new messages (useRef + useEffect)
- Enter to send (Shift+Enter for newline)
- Stop button during streaming (calls `stop()`)
- Error display if error state

6. **Message rendering:**
- Use getMessageText helper (extract text from parts array)
- Different styles for user vs assistant messages
- cn() for conditional classes

Pattern: See 06-RESEARCH.md "Chat UI Component" for full implementation.
Copy/adapt from existing clarifying-chat.tsx for consistency.
  </action>
  <verify>
    - File exists at src/app/(dashboard)/courses/[courseId]/chat/components/mentor-chat.tsx
    - 'use client' directive present
    - MentorChat component exported
    - Uses useChat with DefaultChatTransport
    - Has Textarea input, not Input (multiline support)
    - Has stop button functionality
  </verify>
  <done>MentorChat client component with streaming UI, auto-scroll, and stop functionality</done>
</task>

<task type="auto">
  <name>Task 2: Create chat page</name>
  <files>src/app/(dashboard)/courses/[courseId]/chat/page.tsx</files>
  <action>
Create server component chat page:

1. Create directory `src/app/(dashboard)/courses/[courseId]/chat/` if not exists
2. Create `page.tsx` as server component (no 'use client')

**Implementation:**

```typescript
import { redirect, notFound } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';
import { getCourse } from '@/lib/dal/courses';
import { MentorChat } from './components/mentor-chat';

interface ChatPageProps {
  params: Promise<{ courseId: string }>;
}

export default async function ChatPage({ params }: ChatPageProps) {
  const { courseId } = await params;

  // Auth check
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  // Get course (getCourse only takes courseId - it fetches by id)
  const course = await getCourse(courseId);

  if (!course) {
    notFound();
  }

  // Verify ownership (RLS + defense-in-depth)
  if (course.user_id !== user.id) {
    notFound();
  }

  return (
    <div className="h-[calc(100vh-4rem)] flex flex-col">
      <div className="border-b px-4 py-3">
        <h1 className="text-lg font-semibold">Chat z mentorem</h1>
        <p className="text-sm text-muted-foreground">{course.title}</p>
      </div>
      <div className="flex-1 overflow-hidden">
        <MentorChat courseId={courseId} courseTitle={course.title} />
      </div>
    </div>
  );
}
```

**Key points:**
- Full height layout (minus header: 4rem)
- Header with "Chat z mentorem" and course title
- Flex-1 for chat area (takes remaining space)
- MentorChat rendered in overflow-hidden container
- getCourse(courseId) followed by ownership check (matches existing pattern in project)
  </action>
  <verify>
    - File exists at src/app/(dashboard)/courses/[courseId]/chat/page.tsx
    - No 'use client' directive (server component)
    - Imports MentorChat from ./components/mentor-chat
    - Has auth check with redirect
    - Gets course with getCourse(courseId) from DAL
    - Has ownership check: course.user_id !== user.id
    - Passes courseId and courseTitle to MentorChat
  </verify>
  <done>Chat page server component with auth, course loading, and MentorChat integration</done>
</task>

<task type="auto">
  <name>Task 3: Add chat navigation link</name>
  <files>src/app/(dashboard)/courses/[courseId]/page.tsx</files>
  <action>
Add link to chat in course page:

1. Open existing course page
2. Add link/button to navigate to chat:

```typescript
import { MessageCircle } from 'lucide-react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';

// In the page component, add a button/link:
<Link href={`/courses/${courseId}/chat`}>
  <Button variant="outline" size="sm">
    <MessageCircle className="h-4 w-4 mr-2" />
    Chat z mentorem
  </Button>
</Link>
```

Place the link in an appropriate location (e.g., in the header area or alongside course actions).
Pattern: Follow existing button placements in the page.
  </action>
  <verify>
    - Course page has Link to /courses/${courseId}/chat
    - Button or link has "Chat z mentorem" or similar text
    - MessageCircle icon imported from lucide-react
  </verify>
  <done>Course page has navigation link to mentor chat</done>
</task>

</tasks>

<verification>
After all tasks:
1. TypeScript compiles: `npx tsc --noEmit`
2. Navigate to /courses/[courseId]/chat - page loads
3. Chat shows welcome message
4. Can type and send messages (if API running)
5. Link visible on course page
</verification>

<success_criteria>
- Chat page accessible at /courses/[courseId]/chat
- MentorChat component renders with welcome message
- Streaming UI with loading states
- Stop button functional during streaming
- Navigation from course page to chat
</success_criteria>

<output>
After completion, create `.planning/phases/06-mentor-chatbot/06-03-SUMMARY.md`
</output>
