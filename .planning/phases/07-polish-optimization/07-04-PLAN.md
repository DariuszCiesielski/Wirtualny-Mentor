---
phase: 07-polish-optimization
plan: 04
type: execute
wave: 3
depends_on: ["07-01", "07-02", "07-03"]
files_modified:
  - next.config.ts
  - package.json
  - src/app/(dashboard)/courses/[courseId]/chat/page.tsx
  - src/components/materials/chapter-content.tsx
autonomous: false

must_haves:
  truths:
    - "Bundle analyzer dostepny przez ANALYZE=true npm run build"
    - "Ciezkie komponenty sa lazy-loaded (np. MentorChat)"
    - "Build przechodzi bez bledow"
    - "Initial load time nie wzrosl"
  artifacts:
    - path: "next.config.ts"
      provides: "Bundle analyzer configuration"
      contains: "bundleAnalyzer"
    - path: "package.json"
      provides: "Bundle analyzer i SWR dependencies"
      contains: "@next/bundle-analyzer"
  key_links:
    - from: "next.config.ts"
      to: "@next/bundle-analyzer"
      via: "withBundleAnalyzer wrapper"
      pattern: "withBundleAnalyzer"
---

<objective>
Zoptymalizowac performance przez bundle analysis i lazy loading ciezkich komponentow.

Purpose: Spelnienie kryterium "performance zoptymalizowany" - lazy loading, caching
Output: Bundle analyzer setup, lazy-loaded components, SWR dla client caching
</objective>

<execution_context>
@C:\Users\dariu\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dariu\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-polish-optimization/07-RESEARCH.md

# Components to analyze
@src/app/(dashboard)/courses/[courseId]/chat/page.tsx
@src/components/materials/chapter-content.tsx

# Performance patterns:
# - @next/bundle-analyzer for size analysis
# - next/dynamic for lazy loading
# - SWR for client-side caching
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zainstaluj i skonfiguruj bundle analyzer</name>
  <files>package.json, next.config.ts</files>
  <action>
1. Zainstaluj pakiety:
```bash
npm install @next/bundle-analyzer swr
```

2. Zaktualizuj next.config.ts:
```typescript
import type { NextConfig } from 'next';
import bundleAnalyzer from '@next/bundle-analyzer';

const withBundleAnalyzer = bundleAnalyzer({
  enabled: process.env.ANALYZE === 'true',
  openAnalyzer: true,
});

const nextConfig: NextConfig = {
  // Existing config options
  experimental: {
    // Enable optimizations
    optimizePackageImports: ['lucide-react', '@radix-ui/react-icons'],
  },
  // Image optimization
  images: {
    formats: ['image/avif', 'image/webp'],
  },
};

export default withBundleAnalyzer(nextConfig);
```

Kluczowe:
- `ANALYZE=true npm run build` otwiera bundle visualizer
- optimizePackageImports dla tree-shaking ikon
- Modern image formats dla lepszej kompresji
  </action>
  <verify>
- package.json ma @next/bundle-analyzer i swr
- next.config.ts eksportuje withBundleAnalyzer(nextConfig)
- `npm run build` przechodzi
- `ANALYZE=true npm run build` otwiera wizualizacje
  </verify>
  <done>Bundle analyzer skonfigurowany i gotowy do uzycia</done>
</task>

<task type="auto">
  <name>Task 2: Lazy-load MentorChat component</name>
  <files>src/app/(dashboard)/courses/[courseId]/chat/page.tsx</files>
  <action>
Zaktualizuj chat page aby lazy-loadowac MentorChat:

```typescript
/**
 * Chat Page - Server Component
 *
 * Verifies course ownership and renders MentorChat.
 * MentorChat is lazy-loaded as it's a heavy client component.
 */

import { requireAuth } from '@/lib/dal/auth';
import { getCourse } from '@/lib/dal/courses';
import { redirect, notFound } from 'next/navigation';
import dynamic from 'next/dynamic';
import { Skeleton } from '@/components/ui/skeleton';

// Lazy load MentorChat - heavy client component with AI SDK
const MentorChat = dynamic(
  () => import('./components/mentor-chat').then(mod => ({ default: mod.MentorChat })),
  {
    loading: () => (
      <div className="flex flex-col h-[calc(100vh-10rem)] max-w-4xl mx-auto">
        <div className="flex-1 space-y-4 p-4">
          <Skeleton className="h-16 w-3/4" />
          <Skeleton className="h-16 w-1/2 ml-auto" />
          <Skeleton className="h-16 w-2/3" />
        </div>
        <Skeleton className="h-14 mx-4 mb-4" />
      </div>
    ),
    ssr: false, // Client-only - uses useChat hook
  }
);

interface ChatPageProps {
  params: Promise<{ courseId: string }>;
}

export default async function ChatPage({ params }: ChatPageProps) {
  const user = await requireAuth();
  const { courseId } = await params;

  // Verify course exists and belongs to user
  const course = await getCourse(courseId);

  if (!course) {
    notFound();
  }

  if (course.userId !== user.id) {
    redirect('/courses');
  }

  return (
    <div className="container py-6">
      <h1 className="text-2xl font-bold mb-6">Mentor - {course.topic}</h1>
      <MentorChat courseId={courseId} courseTopic={course.topic} />
    </div>
  );
}
```

Kluczowe:
- `ssr: false` - MentorChat uzywa useChat hook (client-only)
- Loading skeleton dla lepszego UX podczas ladowania
- Zmniejsza initial bundle - MentorChat ladowany on-demand
  </action>
  <verify>
- Chat page uzywa dynamic import
- Loading skeleton wyswietla sie przed zaladowaniem
- `npm run build` przechodzi
- Strona /courses/[id]/chat dziala poprawnie
  </verify>
  <done>MentorChat lazy-loaded dla lepszego initial load</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Bundle analyzer setup i lazy loading MentorChat component. Konfiguracja optymalizacji obrazow i tree-shaking ikon.
  </what-built>
  <how-to-verify>
1. Uruchom bundle analysis:
```bash
ANALYZE=true npm run build
```
   - Powinien otworzyc sie browser z wizualizacja bundle
   - Sprawdz rozmiary glownych chunks
   - Zidentyfikuj duze dependencies

2. Test lazy loading:
   - Uruchom `npm run dev`
   - Otworz DevTools -> Network
   - Przejdz do /courses/[id]/chat
   - Sprawdz czy MentorChat laduje sie osobnym chunk'iem
   - Loading skeleton powinien byc widoczny przez chwile

3. Sprawdz czy aplikacja dziala:
   - Wszystkie strony sie laduja
   - Chat dziala normalnie po zaladowaniu
   - Brak bledow w konsoli
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` przechodzi bez bledow i warnings

2. Bundle analysis:
   - `ANALYZE=true npm run build` otwiera wizualizacje
   - Zidentyfikuj top 3 najwieksze dependencies
   - Zapisz baseline rozmiarow do porownan w przyszlosci

3. Lazy loading verification:
   - Network tab pokazuje oddzielny request dla MentorChat chunk
   - Loading state wyswietla sie podczas ladowania
   - Po zaladowaniu chat dziala normalnie

4. Regression testing:
   - Wszystkie strony laduja sie poprawnie
   - Quiz, notes, materials dzialaja
   - Responsive design (z 07-01) dziala
</verification>

<success_criteria>
- [ ] @next/bundle-analyzer zainstalowany i skonfigurowany
- [ ] ANALYZE=true npm run build dziala
- [ ] MentorChat lazy-loaded z loading skeleton
- [ ] SWR zainstalowany (gotowy do uzycia w przyszlosci)
- [ ] Build przechodzi bez bledow
- [ ] Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-optimization/07-04-SUMMARY.md`
</output>
